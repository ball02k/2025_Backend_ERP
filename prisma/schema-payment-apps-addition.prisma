// ==============================================================================
// PAYMENT APPLICATIONS SYSTEM - UK CONSTRUCTION ACT COMPLIANT
// Add these models and enums to schema.prisma
// ==============================================================================

// Add these enums near the top of the schema file
enum PaymentApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  CERTIFIED
  PAYMENT_NOTICE_SENT
  PAY_LESS_ISSUED
  APPROVED
  PAID
  PARTIALLY_PAID
  DISPUTED
  REJECTED
  WITHDRAWN
}

enum RetentionReleaseType {
  PRACTICAL_COMPLETION
  FINAL_ACCOUNT
  EARLY_RELEASE
  RETENTION_BOND
}

// ==============================================================================
// ENHANCE EXISTING ApplicationForPayment MODEL
// Replace the existing ApplicationForPayment model with this enhanced version
// ==============================================================================

model ApplicationForPayment {
  id              Int       @id @default(autoincrement())
  tenantId        String

  // Relationships
  projectId       Int
  project         Project   @relation(fields: [projectId], references: [id])
  supplierId      Int?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  contractId      Int?
  contract        Contract? @relation(fields: [contractId], references: [id])

  // Application Details
  applicationNumber Int      // Sequential per contract: 1, 2, 3...
  applicationNo     String   // e.g. "PA-001", "AFP-2025-00012" (unique per tenant)
  reference         String?  // Alternative reference
  title             String?  // "Payment Application #3 - May 2025"

  // Dates (Critical for Act compliance)
  applicationDate   DateTime // When contractor submits
  valuationDate     DateTime // Cut-off for measuring work (assessment date)
  dueDate           DateTime // When payment becomes due (7-14 days)
  finalPaymentDate  DateTime // Last day to pay (21-28 days from due)

  // Legacy period dates (keep for compatibility)
  periodStart       DateTime?
  periodEnd         DateTime?
  assessmentDate    DateTime? // JCT IVD / NEC assessment date (maps to valuationDate)

  // Status
  status            String   // Use PaymentApplicationStatus values as strings

  // Currency
  currency          String   @default("GBP")

  // CONTRACTOR'S CLAIMED FIGURES
  claimedGrossValue     Decimal @default(0) @db.Decimal(12, 2)
  claimedRetention      Decimal @default(0) @db.Decimal(12, 2)
  claimedNetValue       Decimal @default(0) @db.Decimal(12, 2)
  claimedPreviouslyPaid Decimal @default(0) @db.Decimal(12, 2)
  claimedThisPeriod     Decimal @default(0) @db.Decimal(12, 2)

  // Legacy claimed fields (keep for compatibility)
  grossToDate           Decimal @default(0) @db.Decimal(18, 2)
  variationsValue       Decimal @default(0) @db.Decimal(18, 2)
  prelimsValue          Decimal @default(0) @db.Decimal(18, 2)
  retentionValue        Decimal @default(0) @db.Decimal(18, 2)
  mosValue              Decimal @default(0) @db.Decimal(18, 2) // materials on site
  offsiteValue          Decimal @default(0) @db.Decimal(18, 2) // materials off site
  deductionsValue       Decimal @default(0) @db.Decimal(18, 2) // contra charges
  netClaimed            Decimal @default(0) @db.Decimal(18, 2)

  // QS/COST MANAGER'S CERTIFIED FIGURES
  certifiedGrossValue     Decimal? @db.Decimal(12, 2)
  certifiedRetention      Decimal? @db.Decimal(12, 2)
  certifiedNetValue       Decimal? @db.Decimal(12, 2)
  certifiedPreviouslyPaid Decimal? @db.Decimal(12, 2)
  certifiedThisPeriod     Decimal? @db.Decimal(12, 2)

  // Legacy certification (keep for compatibility)
  certifiedAmount         Decimal? @db.Decimal(18, 2)
  certifiedDate           DateTime?
  certifiedByUserId       Int?
  certificationNotes      String?  @db.Text

  // Actual payment
  amountPaid              Decimal? @db.Decimal(12, 2)
  paidDate                DateTime?
  paymentReference        String?  // Bank transfer ref, cheque number

  // Breakdown (JSON for flexibility)
  lineItems             Json?    // Array of work packages valued
  variations            Json?    // Variations included
  materialsOnSite       Json?    // Materials stored on site
  previouslyValued      Json?    // Cumulative from last application

  // Documents
  submissionDocument    String?  // Contractor's application PDF
  valuationDocument     String?  // QS assessment/certificate
  paymentNoticeDocument String?  // Formal payment notice
  payLessNoticeDocument String?  // If issuing pay-less

  // Notes & Comments
  contractorNotes       String?  @db.Text
  qsNotes               String?  @db.Text
  internalNotes         String?  @db.Text
  rejectionReason       String?  @db.Text
  notes                 String?  @db.Text // Legacy field

  // People
  submittedBy           Int?     // Contractor user/contact ID
  submittedAt           DateTime?
  reviewedBy            Int?     // QS/Cost manager
  reviewedAt            DateTime?
  approvedBy            Int?     // Finance/PM approval
  approvedAt            DateTime?

  // Payment Notice Tracking
  paymentNoticeSent       Boolean  @default(false)
  paymentNoticeSentAt     DateTime?
  paymentNoticeAmount     Decimal? @db.Decimal(12, 2)
  paymentNoticeIssuedAt   DateTime? // Legacy

  payLessNoticeSent       Boolean  @default(false)
  payLessNoticeSentAt     DateTime?
  payLessNoticeAmount     Decimal? @db.Decimal(12, 2)
  payLessNoticeReason     String?  @db.Text
  payLessReason           String?  @db.Text // Legacy
  payLessNoticeIssuedAt   DateTime? // Legacy

  // Retention Tracking
  retentionPercentage     Decimal  @default(5.0) @db.Decimal(5, 2)
  retentionHeldToDate     Decimal  @default(0) @db.Decimal(12, 2)
  retentionReleasedPC     Decimal  @default(0) @db.Decimal(12, 2) // At Practical Completion
  retentionReleasedFinal  Decimal  @default(0) @db.Decimal(12, 2) // After defects period

  // Compliance & Audit
  isActCompliant          Boolean  @default(true)
  complianceNotes         String?  @db.Text
  disputeRaised           Boolean  @default(false)
  disputeDetails          String?  @db.Text

  // Timestamps
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  attachments             AfpAttachment[]
  lineItemDetails         PaymentApplicationLineItem[]

  @@unique([tenantId, applicationNo])
  @@unique([contractId, applicationNumber])
  @@index([tenantId, projectId, applicationDate])
  @@index([tenantId, supplierId])
  @@index([tenantId, status])
  @@index([contractId, status])
  @@index([projectId, status])
  @@index([dueDate])
  @@index([finalPaymentDate])
  @@index([tenantId, contractId, applicationNumber])
}

// ==============================================================================
// NEW MODEL: Payment Application Line Items
// ==============================================================================

model PaymentApplicationLineItem {
  id                    Int      @id @default(autoincrement())
  tenantId              String

  applicationId         Int
  application           ApplicationForPayment @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  packageId             Int?

  description           String
  reference             String?  // BOQ item reference

  // Quantities
  quantityPrevious      Decimal? @db.Decimal(12, 4)
  quantityThisPeriod    Decimal? @db.Decimal(12, 4)
  quantityCumulative    Decimal? @db.Decimal(12, 4)
  unit                  String?

  // Values
  rate                  Decimal? @db.Decimal(12, 4)
  valuePrevious         Decimal  @default(0) @db.Decimal(12, 2)
  valueThisPeriod       Decimal  @default(0) @db.Decimal(12, 2)
  valueCumulative       Decimal  @default(0) @db.Decimal(12, 2)

  // QS Assessment (if different from claimed)
  qsCertifiedQuantity   Decimal? @db.Decimal(12, 4)
  qsCertifiedValue      Decimal? @db.Decimal(12, 2)
  qsNotes               String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([tenantId, applicationId])
  @@index([packageId])
}

// ==============================================================================
// NEW MODEL: Retention Releases
// ==============================================================================

model RetentionRelease {
  id                      Int      @id @default(autoincrement())
  tenantId                String

  contractId              Int
  contract                Contract @relation(fields: [contractId], references: [id])

  releaseType             String   // Use RetentionReleaseType values
  releaseAmount           Decimal  @db.Decimal(12, 2)
  releaseDate             DateTime

  // Trigger events
  practicalCompletionDate DateTime?
  defectsEndDate          DateTime?

  approvedBy              Int?
  approvedAt              DateTime?

  notes                   String?  @db.Text
  document                String?  // Certificate/approval doc

  createdAt               DateTime @default(now())

  @@index([tenantId, contractId])
  @@index([releaseDate])
}

// ==============================================================================
// ENHANCE EXISTING Contract MODEL
// Add these fields to the existing Contract model
// ==============================================================================

// Add to Contract model relations:
//   paymentApplications    ApplicationForPayment[]
//   retentionReleases      RetentionRelease[]

// Add these new fields to Contract model:
/*
  // Payment Terms
  paymentFrequency       String   @default("MONTHLY") // MONTHLY, MILESTONE, STAGE
  paymentDueDays         Int      @default(14)    // Days from valuation to due date
  paymentFinalDays       Int      @default(21)    // Days from due date to final date
  retentionPercentage    Decimal  @default(5.0)   @db.Decimal(5, 2)
  retentionLimit         Decimal? @db.Decimal(12, 2) // Max retention amount (cap)

  // Payment Application Settings
  valuationDayOfMonth    Int?     // e.g., 25 (last Friday approximation)
  nextApplicationDue     DateTime?

  // Cumulative Tracking
  totalPaidToDate        Decimal  @default(0) @db.Decimal(12, 2)
  retentionHeld          Decimal  @default(0) @db.Decimal(12, 2)
  retentionReleased      Decimal  @default(0) @db.Decimal(12, 2)
*/
