generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ProjectStatus {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectStatusRel")

  @@unique([tenantId, key])
}

model ProjectType {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectTypeRel")

  @@unique([tenantId, key])
}

model TaskStatus {
  id        Int     @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  tasks     Task[]  @relation("TaskStatusRel")

  @@unique([tenantId, key])
}

model Client {
  id           Int       @id @default(autoincrement())
  name         String
  companyRegNo String?
  vatNo        String?
  address1     String?
  address2     String?
  city         String?
  county       String?
  postcode     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  projects     Project[]
  contacts     Contact[] // REQUIRED for includes/counts

  @@index([name])
  @@index([vatNo])
  @@index([companyRegNo])
}

model Project {
  id          Int     @id @default(autoincrement())
  tenantId    String   @default("demo")
  code        String  @unique
  name        String
  description String?

  clientId Int?
  client   Client? @relation(fields: [clientId], references: [id])

  // Legacy lookup relations (retain for compatibility)
  statusId  Int?
  statusRel ProjectStatus? @relation("ProjectStatusRel", fields: [statusId], references: [id])
  typeId    Int?
  typeRel   ProjectType?   @relation("ProjectTypeRel", fields: [typeId], references: [id])

  // Simple string fields for lean project
  status         String   @default("Active")
  type           String   @default("General")
  projectManagerId Int?
  country        String?
  currency       String?
  unitSystem     String?
  taxScheme      String?
  contractForm   String?
  startPlanned   DateTime?
  endPlanned     DateTime?
  startActual    DateTime?
  endActual      DateTime?
  labels         Json?

  // Existing financial/schedule fields retained
  budget      Decimal?  @db.Decimal(18, 2)
  actualSpend Decimal?  @db.Decimal(18, 2)
  startDate   DateTime?
  endDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks      Task[]
  variations Variation[]
  snapshot   ProjectSnapshot?

  @@index([tenantId, status])
}

model Task {
  id        Int     @id @default(autoincrement())
  projectId Int
  tenantId  String   @default("demo")
  project   Project @relation(fields: [projectId], references: [id])

  title       String
  description String?
  dueDate     DateTime?
  assignee    String?

  status     String   @default("Open")

  statusId  Int
  statusRel TaskStatus @relation("TaskStatusRel", fields: [statusId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, status])
  @@index([projectId, dueDate])
}

model Contact {
  id       Int    @id @default(autoincrement())
  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  firstName String
  lastName  String?
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, email])
  @@index([clientId, isPrimary])
  @@index([email])
  @@index([role])
}

model Variation {
  id        Int     @id @default(autoincrement())
  projectId Int
  tenantId  String
  project   Project @relation(fields: [projectId], references: [id])

  // Core identifiers
  referenceCode String? @db.VarChar(64)
  title         String  @db.VarChar(255)
  description   String? @db.Text

  // Strings (avoid Prisma enums)
  type        String  @db.VarChar(24)
  status      String  @db.VarChar(24)
  reason_code String? @db.VarChar(64)

  // Commercials
  estimated_cost Decimal? @db.Decimal(18, 2)
  estimated_sell Decimal? @db.Decimal(18, 2)
  agreed_cost    Decimal? @db.Decimal(18, 2)
  agreed_sell    Decimal? @db.Decimal(18, 2)

  // Dates
  notifiedDate   DateTime?
  submittedDate  DateTime?
  reviewedDate   DateTime?
  approvedDate   DateTime?
  rejectedDate   DateTime?
  instructedDate DateTime?
  pricedDate     DateTime?
  agreedDate     DateTime?
  voIssuedDate   DateTime?
  voAcceptedDate DateTime?

  // Meta
  is_deleted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  lines         VariationLine[]
  statusHistory VariationStatusHistory[]

  @@index([projectId])
  @@index([type])
  @@index([status])
  @@index([referenceCode])
  @@index([tenantId, projectId])
  @@index([tenantId, projectId, status])
}

model VariationLine {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])

  cost_code   String?  @db.VarChar(64)
  description String   @db.VarChar(255)
  qty         Decimal  @db.Decimal(18, 2)
  unit        String?  @db.VarChar(32)
  unit_cost   Decimal  @db.Decimal(18, 2)
  unit_sell   Decimal? @db.Decimal(18, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([variationId])
}

model VariationStatusHistory {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])

  fromStatus String?  @db.VarChar(24)
  toStatus   String   @db.VarChar(24)
  note       String?  @db.VarChar(255)
  changedAt  DateTime @default(now())

  @@index([variationId])
}

model ProjectSnapshot {
  projectId             Int     @id
  tenantId              String

  // Financial
  budget                Decimal? @db.Decimal(18,2)
  committed             Decimal? @db.Decimal(18,2)
  actual                Decimal? @db.Decimal(18,2)
  retentionHeld         Decimal? @db.Decimal(18,2)
  forecastAtComplete    Decimal? @db.Decimal(18,2)
  variance              Decimal? @db.Decimal(18,2)

  // Schedule
  schedulePct           Int?
  criticalAtRisk        Int?

  // Variations
  variationsDraft         Int?
  variationsSubmitted     Int?
  variationsApproved      Int?
  variationsValueApproved Decimal? @db.Decimal(18,2)

  // Tasks
  tasksOverdue          Int?
  tasksDueThisWeek      Int?

  // RFIs (placeholder counts until RFI module lands)
  rfisOpen              Int?
  rfisAvgAgeDays        Int?

  // QA/QC
  qaOpenNCR             Int?
  qaOpenPunch           Int?

  // H&S
  hsIncidentsThisMonth  Int?
  hsOpenPermits         Int?

  // Procurement
  procurementCriticalLate Int?
  procurementPOsOpen      Int?

  // Carbon
  carbonTarget          Decimal? @db.Decimal(18,2)
  carbonToDate          Decimal? @db.Decimal(18,2)
  carbonUnit            String?

  updatedAt             DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Document {
  id              BigInt    @id @default(autoincrement())
  fileName        String
  storageKey      String
  storageProvider String
  size            BigInt?
  contentType     String?
  uploadedAt      DateTime  @default(now())
  uploadedBy      String?
  tags            String?   @db.Text // CSV of lowercase tokens
  is_deleted      Boolean   @default(false)
  deletedAt       DateTime?

  links DocumentLink[]
  // If you want to map to an existing lowercase table, uncomment:
  // @@map("documents")

  @@index([uploadedAt])
}

model DocumentLink {
  id          BigInt   @id @default(autoincrement())
  documentId  BigInt
  projectId   Int?
  variationId Int?
  note        String?
  createdAt   DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])
  // If you have Project/Variation models with BigInt ids, you can add relations later.
  // For now they remain nullable numeric FKs without relation constraints.

  @@index([projectId])
  @@index([variationId])
}
