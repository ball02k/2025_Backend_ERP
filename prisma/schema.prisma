// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Currency {
  GBP
  EUR
  USD
}

enum ProjectStatus {
  Planned
  Active
  OnHold
  Completed
  Cancelled
}

enum RiskStatus {
  Open
  Mitigated
  Closed
  Accepted
}

enum RiskCategory {
  Program
  Cost
  Quality
  HSE
  Contract
  Design
  SupplyChain
  Environmental
  Other
}

enum Severity {
  Low
  Medium
  High
  Critical
}

enum TenderStatus {
  Draft
  Open
  Closed
  Awarded
  Cancelled
}

enum HseType {
  Incident
  NearMiss
  Observation
  Inspection
}

enum ScopeType {
  SCOPE1
  SCOPE2
  SCOPE3
}

enum DocStatus {
  Draft
  Submitted
  Approved
  Rejected
  Superseded
}

enum ContractType {
  NEC3
  NEC4
  JCT
  FIDIC
  PPC
  Other
}

enum WorkStage {
  Concept
  Feasibility
  Design
  Tender
  Construction
  Handover
  Closeout
}

// -------- Tenancy / Users --------
model Company {
  id         Int       @id @default(autoincrement())
  name       String
  domain     String?
  phone      String?
  address_json Json?
  timezone   String?
  currency   Currency? @default(GBP)

  users      User[]
  projects   Project[]
  suppliers  Supplier[]

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
}

model User {
  id            Int      @id @default(autoincrement())
  company_id    Int
  company       Company  @relation(fields: [company_id], references: [id])
  name          String
  email         String   @unique
  phone_number  String?
  role          String?
  permissions   Json?
  is_active     Boolean  @default(true)

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([company_id])
}

// -------- CRM / Clients --------
model Client {
  id            Int       @id @default(autoincrement())
  company_id    Int?
  company       Company?  @relation(fields: [company_id], references: [id])

  name          String
  registration_number String?
  vat_number    String?
  address_line1 String?
  address_line2 String?
  city          String?
  postcode      String?
  country       String?
  address       Json?
  website       String?
  industry      String?
  logo_url      String?
  turnover      Int?

  account_manager_id Int?
  account_manager    User? @relation(fields: [account_manager_id], references: [id])

  is_deleted    Boolean  @default(false)
  deleted_at    DateTime?

  projects      Project[]

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([company_id])
  @@index([account_manager_id])
}

// -------- Projects --------
model Project {
  id                        Int            @id @default(autoincrement())
  company_id                Int?
  company                   Company?       @relation(fields:[company_id], references:[id])

  client_id                 Int?
  client                    Client?        @relation(fields: [client_id], references: [id])

  project_code              String?        @unique
  project_name              String
  description               String?
  status                    ProjectStatus  @default(Planned)
  type                      String?
  contract_type             ContractType?
  sector                    String?
  work_stage                WorkStage?
  project_manager           String?
  project_manager_id        Int?
  pm_user                   User?          @relation("ProjectPM", fields: [project_manager_id], references: [id])
  quantity_surveyor         String?
  qs_user_id                Int?
  qs_user                   User?          @relation("ProjectQS", fields: [qs_user_id], references:[id])
  location                  String?
  lat                       Float?
  lng                       Float?

  address_line1             String?
  address_line2             String?
  city                      String?
  postcode                  String?
  country                   String?
  address                   Json?

  currency                  Currency       @default(GBP)
  budget                    Decimal?       @db.Decimal(18,2)
  actual_spend              Decimal?       @db.Decimal(18,2)
  committed_cost            Decimal?       @db.Decimal(18,2)
  approved_variations       Decimal?       @db.Decimal(18,2)
  pending_variations        Decimal?       @db.Decimal(18,2)
  forecast_final_cost       Decimal?       @db.Decimal(18,2)

  baseline_start            DateTime?
  baseline_end              DateTime?
  start_date                DateTime?
  end_date                  DateTime?
  estimated_completion_date DateTime?
  actual_completion_date    DateTime?

  risk_level                String?
  carbon_target             Decimal?       @db.Decimal(18,3)
  carbon_measured           Decimal?       @db.Decimal(18,3)
  progress_pct              Int?
  priority_label            String?
  milestone_summary         String?
  project_tags              String[]

  is_flagged                Boolean        @default(false)
  team_notes                String?

  is_deleted                Boolean        @default(false)
  deleted_at                DateTime?

  created_by_id             Int?
  updated_by_id             Int?

  // Relations
  milestones        Milestone[]
  tasks             Task[]
  risks             Risk[]
  tender            Tender[]
  inventory         Inventory[]
  carbon            CarbonRecord[]
  timeline          TimelineEvent[]
  hse_records       HealthSafetyRecord[]
  cvr               CVRReport[]
  cost_entries      CostEntry[]
  files             File[]
  reports           Report[]
  team_members      ProjectTeamMember[]
  status_history    ProjectStatusHistory[]

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([company_id])
  @@index([client_id])
  @@index([status])
  @@index([project_manager_id])
  @@index([qs_user_id])
}

model ProjectStatusHistory {
  id         Int           @id @default(autoincrement())
  project_id Int
  project    Project       @relation(fields:[project_id], references:[id])
  from       ProjectStatus?
  to         ProjectStatus
  note       String?
  changed_by Int?
  changed_at DateTime      @default(now())
  @@index([project_id])
}

model Milestone {
  id         Int      @id @default(autoincrement())
  project_id Int
  project    Project  @relation(fields:[project_id], references:[id])
  title      String
  status     String?
  due_date   DateTime?
  completed_at DateTime?
  @@index([project_id])
}

// -------- Tasks / Schedule --------
model Task {
  id              Int       @id @default(autoincrement())
  project_id      Int
  project         Project   @relation(fields:[project_id], references:[id])
  name            String
  description     String?
  status          String?
  priority        String?
  assignee_id     Int?
  created_by_id   Int?
  due_date        DateTime?
  start_date      DateTime?
  end_date        DateTime?
  percent_complete Int?
  baseline_start  DateTime?
  baseline_end    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  subtasks        Subtask[]
  comments        Comment[]
  predecessors    TaskDependency[] @relation("TaskDeps")
  successors      TaskDependency[] @relation("TaskPreds")

  @@index([project_id])
}

model TaskDependency {
  id             Int   @id @default(autoincrement())
  task_id        Int
  predecessor_id Int
  type           String?
  lag_days       Int?

  task         Task  @relation("TaskDeps", fields:[task_id], references:[id])
  predecessor  Task  @relation("TaskPreds", fields:[predecessor_id], references:[id])

  @@index([task_id])
  @@index([predecessor_id])
}

model Subtask {
  id        Int     @id @default(autoincrement())
  task_id   Int
  task      Task    @relation(fields:[task_id], references:[id])
  title     String
  completed Boolean @default(false)
}

model Comment {
  id       Int     @id @default(autoincrement())
  task_id  Int
  task     Task    @relation(fields:[task_id], references:[id])
  text     String
  user_id  Int?
  created_at DateTime @default(now())
}

// -------- Risks --------
model Risk {
  id          Int          @id @default(autoincrement())
  project_id  Int
  project     Project      @relation(fields:[project_id], references:[id])
  description String
  category    RiskCategory @default(Other)
  probability Decimal      @db.Decimal(5,2)
  impact      Decimal      @db.Decimal(5,2)
  score       Decimal?     @db.Decimal(6,2)
  owner       String?
  mitigation  String?
  status      RiskStatus   @default(Open)
  opened_at   DateTime     @default(now())
  closed_at   DateTime?
  history     RiskStatusHistory[]

  @@index([project_id])
  @@index([status])
}

model RiskStatusHistory {
  id        Int        @id @default(autoincrement())
  risk_id   Int
  risk      Risk       @relation(fields:[risk_id], references:[id])
  from      RiskStatus?
  to        RiskStatus
  note      String?
  changed_by Int?
  changed_at DateTime   @default(now())
  @@index([risk_id])
}

// -------- Inventory / Procurement --------
model Inventory {
  id            Int      @id @default(autoincrement())
  project_id    Int
  project       Project  @relation(fields:[project_id], references:[id])
  sku           String?
  name          String
  description   String?
  quantity      Decimal   @db.Decimal(18,3)
  unit          String?
  unit_price    Decimal?  @db.Decimal(18,2)
  location      String?
  reorder_point Decimal?  @db.Decimal(18,3)
  supplier_id   Int?
  supplier      Supplier? @relation(fields:[supplier_id], references:[id])
  @@index([project_id])
  @@index([supplier_id])
}

model Supplier {
  id                  Int       @id @default(autoincrement())
  company_id          Int?
  company             Company?  @relation(fields:[company_id], references:[id])
  name                String
  email               String?
  phone               String?
  category            String?
  registration_number String?
  vat_number          String?
  approval_status     String?
  risk_rating         String?
  address_json        Json?
  insurance_expiry    DateTime?
  cs_cs_expiry        DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  tenderSubmissions   TenderSubmission[]
  @@index([company_id])
}

model Procurement {
  id             Int      @id @default(autoincrement())
  project_id     Int
  project        Project  @relation(fields:[project_id], references:[id])
  supplier_id    Int?
  supplier       Supplier? @relation(fields:[supplier_id], references:[id])
  rfq_number     String?
  po_number      String?
  item_description String
  quantity       Decimal?  @db.Decimal(18,3)
  unit_price     Decimal?  @db.Decimal(18,2)
  currency       Currency? @default(GBP)
  delivery_date  DateTime?
  status         String?
  approved_by    Int?
  delivered_qty  Decimal?  @db.Decimal(18,3)
  invoice_ref    String?
  @@index([project_id])
  @@index([supplier_id])
}

model ComplianceRecord {
  id          Int       @id @default(autoincrement())
  supplier_id Int
  supplier    Supplier  @relation(fields:[supplier_id], references:[id])
  type        String
  expiry_date DateTime?
  document_url String?
  verified_by Int?
  notes       String?
}

// -------- Carbon --------
model CarbonRecord {
  id          Int       @id @default(autoincrement())
  project_id  Int
  project     Project   @relation(fields:[project_id], references:[id])
  scope       ScopeType
  category    String?
  source      String
  factor      Decimal?     @db.Decimal(18,6)
  value       Decimal      @db.Decimal(18,3)
  unit        String
  recorded_at DateTime     @default(now())
  notes       String?
  @@index([project_id])
  @@index([scope])
}

// -------- Costs / CVR --------
model CostEntry {
  id            Int      @id @default(autoincrement())
  project_id    Int
  project       Project  @relation(fields:[project_id], references:[id])
  category      String
  subcategory   String?
  amount        Decimal  @db.Decimal(18,2)
  currency      Currency @default(GBP)
  description   String?
  date_incurred DateTime
  approved_by   Int?
  invoice_ref   String?
  po_number     String?
  @@index([project_id])
  @@index([date_incurred])
}

model CVRReport {
  id            Int      @id @default(autoincrement())
  project_id    Int
  project       Project  @relation(fields:[project_id], references:[id])
  period_start  DateTime
  period_end    DateTime
  actual_cost   Decimal  @db.Decimal(18,2)
  forecast_cost Decimal  @db.Decimal(18,2)
  earned_value  Decimal? @db.Decimal(18,2)
  adjustments   Json?
  comments      String?
  created_by    Int?
}

// -------- Files / Reports --------
model File {
  id           Int      @id @default(autoincrement())
  filename     String
  url          String
  file_type    String?
  version      Int      @default(1)
  status       DocStatus @default(Draft)
  uploaded_by  Int?
  project_id   Int?
  task_id      Int?
  project      Project? @relation(fields:[project_id], references:[id])
  task         Task?    @relation(fields:[task_id], references:[id])
  supersedes_id Int?
  superseded_by File?   @relation("FileSupersede", fields:[supersedes_id], references:[id])
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  @@index([project_id])
  @@index([task_id])
}

model Report {
  id         Int      @id @default(autoincrement())
  project_id Int
  project    Project  @relation(fields:[project_id], references:[id])
  type       String
  title      String
  content    String?
  author_id  Int?
  created_at DateTime @default(now())
}

// -------- Timeline / HSE --------
model TimelineEvent {
  id          Int      @id @default(autoincrement())
  project_id  Int
  project     Project  @relation(fields:[project_id], references:[id])
  title       String
  description String?
  start_date  DateTime
  end_date    DateTime?
  status      String?
  created_at  DateTime @default(now())
  @@index([project_id])
}

model HealthSafetyRecord {
  id            Int     @id @default(autoincrement())
  project_id    Int
  project       Project @relation(fields:[project_id], references:[id])
  type          HseType
  description   String
  severity      Severity
  occurred_at   DateTime
  location      String?
  coordinates   Json?
  root_cause    String?
  corrective_actions String?
  notifiable    Boolean  @default(false)
  attachments   Json?
  status        String?
  closed_at     DateTime?
  @@index([project_id])
}

// -------- Tendering --------
model Tender {
  id         Int       @id @default(autoincrement())
  project_id Int
  project    Project   @relation(fields:[project_id], references:[id])
  package    String
  description String?
  status     TenderStatus @default(Open)
  open_date  DateTime
  close_date DateTime
  award_date DateTime?
  amount     Decimal?     @db.Decimal(18,2)
  award_to_subcontractor_id Int?
  award_rationale String?
  subcontractors Subcontractor[]
  criteria   TenderCriteria[]
  submissions TenderSubmission[]
  qna        TenderQnA[]
  @@index([project_id])
}

model Subcontractor {
  id          Int       @id @default(autoincrement())
  tender_id   Int
  tender      Tender    @relation(fields:[tender_id], references:[id])
  name        String
  status      String?
  email       String?
  phone       String?
  bid_amount  Decimal? @db.Decimal(18,2)
  awarded     Boolean  @default(false)
  documents   Json?
}

model TenderCriteria {
  id         Int      @id @default(autoincrement())
  tender_id  Int
  tender     Tender   @relation(fields: [tender_id], references: [id])
  name       String
  weight     Decimal  @db.Decimal(5,2)
  type       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  scores     TenderScore[]

  @@index([tender_id])
}

model TenderSubmission {
  id           Int       @id @default(autoincrement())
  tender_id    Int
  supplier_id  Int
  tender       Tender    @relation(fields: [tender_id], references: [id])
  supplier     Supplier  @relation(fields: [supplier_id], references: [id])
  access_token String    @unique
  status       String    @default("draft")
  submitted_at DateTime?
  form_data    Json?
  total_price  Decimal?  @db.Decimal(18,2)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  items        TenderSubmissionItem[]
  scores       TenderScore[]
  questions    TenderQnA[]

  @@index([tender_id])
  @@index([supplier_id])
  @@unique([tender_id, supplier_id])
}

model TenderSubmissionItem {
  id             Int      @id @default(autoincrement())
  submission_id  Int
  submission     TenderSubmission @relation(fields: [submission_id], references: [id], onDelete: Cascade)
  description    String
  quantity       Decimal? @db.Decimal(18,3)
  unit_price     Decimal? @db.Decimal(18,2)
  total          Decimal? @db.Decimal(18,2)

  @@index([submission_id])
}

model TenderQnA {
  id                Int      @id @default(autoincrement())
  tender_id         Int
  submission_id     Int?
  tender            Tender   @relation(fields: [tender_id], references: [id])
  submission        TenderSubmission? @relation(fields: [submission_id], references: [id])
  question          String
  answer            String?
  supplierVisible   Boolean  @default(false)
  asked_at          DateTime @default(now())
  answered_at       DateTime?

  @@index([tender_id])
  @@index([submission_id])
}

model TenderScore {
  id            Int      @id @default(autoincrement())
  criteria_id   Int
  submission_id Int
  criteria      TenderCriteria @relation(fields: [criteria_id], references: [id])
  submission    TenderSubmission @relation(fields: [submission_id], references: [id])
  autoScore     Decimal? @db.Decimal(10,2)
  manualScore   Decimal? @db.Decimal(10,2)
  overrideReason String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([criteria_id, submission_id])
  @@index([submission_id])
  @@index([criteria_id])
}

// -------- Teams / Audit / Alerts --------
model ProjectTeamMember {
  id          Int      @id @default(autoincrement())
  project_id  Int
  user_id     Int
  role        String?
  joined_at   DateTime @default(now())
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String
  table_name  String
  record_id   Int
  user_id     Int?
  changes     Json?
  created_at  DateTime @default(now())
}

model AIAlert {
  id                Int      @id @default(autoincrement())
  type              String
  description       String?
  related_project_id Int?
  severity          String?
  resolved          Boolean  @default(false)
  created_at        DateTime @default(now())
}

model Document {
  id          BigInt                  @id @default(autoincrement())
  tenantId    String
  fileName    String
  storagePath String
  mimeType    String?
  metadata    Json?
  createdAt   DateTime                @default(now())
  createdBy   String?

  contractLinks ContractDocumentLink[]

  @@index([tenantId])
}

model Package {
  id          Int        @id @default(autoincrement())
  tenantId    String
  projectId   Int
  project     Project    @relation(fields: [projectId], references: [id])
  name        String
  description String?
  status      String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  contracts   Contract[]

  @@index([tenantId, projectId])
}

model Contract {
  id           Int                    @id @default(autoincrement())
  tenantId     String
  projectId    Int
  project      Project                @relation(fields: [projectId], references: [id])
  packageId    Int
  package      Package                @relation(fields: [packageId], references: [id])
  supplierId   Int
  supplier     Supplier               @relation(fields: [supplierId], references: [id])
  reference    String
  title        String
  status       String
  value        Decimal                @db.Decimal(18, 2)
  startDate    DateTime?
  endDate      DateTime?
  contractType String
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  createdBy    String
  updatedBy    String
  issuedAt     DateTime?
  issuedBy     String?
  signedAt     DateTime?
  signedBy     String?
  packageLocked Boolean               @default(false)

  lineItems   ContractLineItem[]
  documents   ContractDocumentLink[]

  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
  @@index([tenantId, supplierId])
}

model ContractLineItem {
  id          Int       @id @default(autoincrement())
  tenantId    String
  contractId  Int
  contract    Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal?  @db.Decimal(18, 3)
  rate        Decimal?  @db.Decimal(18, 2)
  total       Decimal?  @db.Decimal(18, 2)
  sortOrder   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId, contractId])
}

model ContractDocumentLink {
  id         Int       @id @default(autoincrement())
  tenantId   String
  contractId Int
  contract   Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  documentId BigInt
  document   Document  @relation(fields: [documentId], references: [id])
  documentType String?
  metadata   Json?
  createdAt  DateTime  @default(now())

  @@index([tenantId, contractId])
  @@index([tenantId, documentId])
}
