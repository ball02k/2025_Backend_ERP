generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  shadowDatabaseUrl = env("PRISMA_MIGRATE_SHADOW_DATABASE_URL")
}

// Supplier Onboarding
model OnboardingProject {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  status    String   @default("draft")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
}

model OnboardingForm {
  id          Int     @id @default(autoincrement())
  tenantId    String
  projectId   Int
  title       String
  version     String  @default("v1")
  isPublished Boolean @default(false)
  sections    Json?

  @@index([tenantId, projectId])
}

model OnboardingInvite {
  id          Int       @id @default(autoincrement())
  tenantId    String
  projectId   Int
  supplierId  Int
  email       String
  token       String
  status      String    @default("invited")
  invitedAt   DateTime  @default(now())
  respondedAt DateTime?

  @@index([tenantId, projectId, status])
}

model OnboardingResponse {
  id          Int       @id @default(autoincrement())
  tenantId    String
  projectId   Int
  supplierId  Int? // link to Supplier when approved
  formId      Int
  answers     Json
  files       Json?
  status      String    @default("in_progress")
  submittedAt DateTime?
  reviewedBy  Int?
  reviewedAt  DateTime?
  decision    String?

  @@index([tenantId, projectId, supplierId, status])
}

model ProjectStatus {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectStatusRel")

  @@unique([tenantId, key])
}

model ProjectType {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectTypeRel")

  @@unique([tenantId, key])
}

model TaskStatus {
  id        Int     @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  tasks     Task[]  @relation("TaskStatusRel")

  @@unique([tenantId, key])
}

model Client {
  id           Int       @id @default(autoincrement())
  name         String
  companyRegNo String?
  vatNo        String?
  address1     String?
  address2     String?
  city         String?
  county       String?
  postcode     String?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  projects     Project[]
  contacts     Contact[] // REQUIRED for includes/counts

  @@index([name])
  @@index([vatNo])
  @@index([companyRegNo])
}

model Project {
  id          Int     @id @default(autoincrement())
  tenantId    String  @default("demo")
  code        String  @unique
  name        String
  description String?

  clientId Int?
  client   Client? @relation(fields: [clientId], references: [id])

  // Legacy lookup relations (retain for compatibility)
  statusId  Int?
  statusRel ProjectStatus? @relation("ProjectStatusRel", fields: [statusId], references: [id])
  typeId    Int?
  typeRel   ProjectType?   @relation("ProjectTypeRel", fields: [typeId], references: [id])

  // Simple string fields for lean project
  status           String    @default("Active")
  type             String    @default("General")
  projectManagerId Int?
  country          String?
  currency         String?
  unitSystem       String?
  taxScheme        String?
  contractForm     String?
  startPlanned     DateTime?
  endPlanned       DateTime?
  startActual      DateTime?
  endActual        DateTime?
  labels           Json?

  // Existing financial/schedule fields retained
  budget      Decimal?  @db.Decimal(18, 2)
  actualSpend Decimal?  @db.Decimal(18, 2)
  startDate   DateTime?
  endDate     DateTime?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tasks          Task[]
  variations     Variation[]
  snapshot       ProjectSnapshot?
  memberships    ProjectMembership[]
  purchaseOrders PurchaseOrder[]

  budgetLines    BudgetLine[]
  commitments    Commitment[]
  actualCosts    ActualCost[]
  forecasts      Forecast[]
  financialItems FinancialItem[]
  packages       Package[]
  contracts      Contract[]
  invoices       Invoice[]

  // Additive relations to new modules
  rfis           Rfi[]
  qaRecords      QaRecord[]
  hsEvents       HsEvent[]
  carbonEntries  CarbonEntry[]

  @@index([tenantId, status])
  @@index([tenantId, name])
  // Hot paths: client-filtered project lists and planned end sorting
  @@index([tenantId, clientId])
  @@index([tenantId, endPlanned])
}

model Task {
  id        Int     @id @default(autoincrement())
  projectId Int
  tenantId  String  @default("demo")
  project   Project @relation(fields: [projectId], references: [id])

  title       String
  description String?
  dueDate     DateTime?
  assignee    String?

  status String @default("Open")

  statusId  Int
  statusRel TaskStatus @relation("TaskStatusRel", fields: [statusId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, status])
  @@index([projectId, dueDate])
  @@index([tenantId, title])
}

model Contact {
  id       Int    @id @default(autoincrement())
  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  tenantId String @default("demo")

  firstName String
  lastName  String?
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, email])
  @@index([tenantId, clientId])
  @@index([clientId, isPrimary])
  @@index([email])
  @@index([role])
}

model Variation {
  id        Int     @id @default(autoincrement())
  projectId Int
  tenantId  String
  project   Project @relation(fields: [projectId], references: [id])

  // Core identifiers
  reference     String? @db.VarChar(64)
  referenceCode String? @db.VarChar(64) // legacy
  title         String  @db.VarChar(255)
  description   String? @db.Text
  contractType  String  @db.VarChar(24)

  // Strings (avoid Prisma enums)
  type        String  @db.VarChar(24)
  status      String  @db.VarChar(24)
  reason      String? @db.VarChar(255)
  reason_code String? @db.VarChar(64) // legacy

  // Commercials
  // New spec fields
  value          Decimal @db.Decimal(18, 2)
  costImpact     Decimal @db.Decimal(18, 2)
  timeImpactDays Int?
  notes          String?

  // Legacy/computed fields retained for compatibility
  estimated_cost Decimal? @db.Decimal(18, 2)
  estimated_sell Decimal? @db.Decimal(18, 2)
  agreed_cost    Decimal? @db.Decimal(18, 2)
  agreed_sell    Decimal? @db.Decimal(18, 2)

  // Dates
  notifiedDate   DateTime?
  submittedDate  DateTime?
  submissionDate DateTime?
  decisionDate   DateTime?
  reviewedDate   DateTime?
  approvedDate   DateTime?
  rejectedDate   DateTime?
  instructedDate DateTime?
  pricedDate     DateTime?
  agreedDate     DateTime?
  voIssuedDate   DateTime?
  voAcceptedDate DateTime?

  // Meta
  is_deleted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  lines         VariationLine[]
  statusHistory VariationStatusHistory[]

  @@index([projectId])
  @@index([type])
  @@index([status])
  @@index([reference])
  @@index([referenceCode])
  @@index([tenantId, projectId])
  @@index([tenantId, projectId, status])
  @@index([tenantId, projectId, status, updatedAt])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([tenantId, title])
  @@index([tenantId, reference])
}

model VariationLine {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])
  tenantId    String

  cost_code   String?  @db.VarChar(64) // legacy
  description String   @db.VarChar(255)
  qty         Decimal  @db.Decimal(18, 3)
  rate        Decimal  @db.Decimal(18, 2)
  value       Decimal  @db.Decimal(18, 2)
  sort        Int      @default(0)
  unit        String?  @db.VarChar(32) // legacy
  unit_cost   Decimal? @db.Decimal(18, 2) // legacy
  unit_sell   Decimal? @db.Decimal(18, 2) // legacy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([variationId])
  @@index([tenantId])
}

model VariationStatusHistory {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])
  tenantId    String

  fromStatus String?  @db.VarChar(24)
  toStatus   String   @db.VarChar(24)
  note       String?  @db.VarChar(255)
  changedAt  DateTime @default(now())

  @@index([variationId])
  @@index([tenantId, variationId, changedAt])
}

model ProjectSnapshot {
  projectId Int    @id
  tenantId  String

  // Financial
  budget             Decimal? @db.Decimal(18, 2)
  committed          Decimal? @db.Decimal(18, 2)
  actual             Decimal? @db.Decimal(18, 2)
  retentionHeld      Decimal? @db.Decimal(18, 2)
  forecastAtComplete Decimal? @db.Decimal(18, 2)
  variance           Decimal? @db.Decimal(18, 2)

  financialBudget    Decimal @default(0)
  financialCommitted Decimal @default(0)
  financialActual    Decimal @default(0)
  financialForecast  Decimal @default(0)

  // Schedule
  schedulePct    Int?
  criticalAtRisk Int?

  // Variations
  variationsDraft         Int?
  variationsSubmitted     Int?
  variationsApproved      Int?
  variationsValueApproved Decimal? @db.Decimal(18, 2)

  // Tasks
  tasksOverdue     Int?
  tasksDueThisWeek Int?

  // RFIs (placeholder counts until RFI module lands)
  rfisOpen       Int?
  rfisAvgAgeDays Int?

  // QA/QC
  qaOpenNCR   Int?
  qaOpenPunch Int?

  // H&S
  hsIncidentsThisMonth Int?
  hsOpenPermits        Int?

  // Procurement
  procurementCriticalLate Int?
  procurementPOsOpen      Int?

  // Carbon
  carbonTarget Decimal? @db.Decimal(18, 2)
  carbonToDate Decimal? @db.Decimal(18, 2)
  carbonUnit   String?

  updatedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Document {
  id           BigInt         @id @default(autoincrement())
  tenantId     String
  filename     String
  mimeType     String
  size         Int
  storageKey   String         @unique
  sha256       String?
  uploadedAt   DateTime       @default(now())
  uploadedById String?
  links        DocumentLink[]

  @@index([tenantId])
  @@index([tenantId, uploadedAt])
}

model DocumentLink {
  id          Int      @id @default(autoincrement())
  tenantId    String
  documentId  BigInt
  projectId   Int?
  variationId Int?
  // NEW optional link targets (additive)
  rfiId         Int?
  qaRecordId    Int?
  hsEventId     Int?
  carbonEntryId Int?
  linkType    String
  createdAt   DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([tenantId, projectId])
  @@index([tenantId, variationId])
  @@index([tenantId, documentId])
  @@index([projectId])
  @@index([variationId])
  @@index([tenantId, rfiId])
  @@index([tenantId, qaRecordId])
  @@index([tenantId, hsEventId])
  @@index([tenantId, carbonEntryId])
}

// --- Additive optional links to new modules ---
// Extend DocumentLink with nullable foreign keys to RFI/QA/H&S/Carbon entries
// Note: This is additive; existing behavior remains unchanged

/// NEW MODELS (Additive): RFI, QA/QC, H&S, Carbon

model Rfi {
  id                Int      @id @default(autoincrement())
  tenantId          String
  projectId         Int
  rfiNumber         String
  subject           String
  question          String
  status            String   @default("open")
  priority          String   @default("med")
  discipline        String?
  packageId         Int?
  requestedByUserId String?
  assignedToUserId  String?
  toCompanyId       Int?
  dueDate           DateTime?
  responseText      String?
  responseByUserId  String?
  respondedAt       DateTime?
  costImpact        String?
  scheduleImpact    String?
  changeRequired    Boolean?
  ccEmails          String?
  tags              String?
  location          String?
  originatorRef     String?
  closedAt          DateTime?
  voidReason        String?
  createdByUserId   String?
  updatedByUserId   String?
  isDeleted         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, status])
  @@index([tenantId, rfiNumber])
}

model QaRecord {
  id                 Int      @id @default(autoincrement())
  tenantId           String
  projectId          Int
  type               String
  title              String
  description        String?
  trade              String?
  location           String?
  lot                String?
  status             String   @default("open")
  raisedByUserId     String?
  assignedToUserId   String?
  dueDate            DateTime?
  itpRef             String?
  testMethod         String?
  acceptanceCriteria String?
  remedialAction     String?
  targetClose        DateTime?
  closedAt           DateTime?
  tags               String?
  reference          String?
  createdByUserId    String?
  updatedByUserId    String?
  isDeleted          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  items   QaItem[]

  @@index([tenantId, projectId, status, type])
}

model QaItem {
  id               Int      @id @default(autoincrement())
  tenantId         String
  qaRecordId       Int
  item             String
  result           String   @default("open")
  notes            String?
  responsibleParty String?
  dueDate          DateTime?
  closedAt         DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  record QaRecord @relation(fields: [qaRecordId], references: [id])

  @@index([tenantId, qaRecordId])
}

model HsEvent {
  id                  Int      @id @default(autoincrement())
  tenantId            String
  projectId           Int
  type                String
  title               String
  description         String
  eventDate           DateTime
  location            String?
  reportedByUserId    String?
  assignedToUserId    String?
  status              String   @default("open")
  severity            String?
  initialRiskRating   String?
  residualRiskRating  String?
  personsInvolved     Json?
  lostTimeHours       Int?
  isRIDDOR            Boolean?
  riddorRef           String?
  regulatorNotified   Boolean?
  regulatorName       String?
  notificationDate    DateTime?
  immediateAction     String?
  rootCause           String?
  correctiveActions   String?
  targetClose         DateTime?
  closedAt            DateTime?
  tags                String?
  createdByUserId     String?
  updatedByUserId     String?
  isDeleted           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, type, status])
}

model CarbonEntry {
  id               Int      @id @default(autoincrement())
  tenantId         String
  projectId        Int
  scope            String
  category         String
  activityDate     DateTime
  quantity         Decimal  @db.Decimal(18, 6)
  unit             String
  emissionFactor   Decimal  @db.Decimal(18, 6)
  factorUnit       String
  calculatedKgCO2e Decimal  @db.Decimal(18, 6)
  supplierId       Int?
  purchaseOrderId  Int?
  poLineId         Int?
  deliveryId       Int?
  factorSource     String?
  factorRef        String?
  materialOrFuel   String?
  vehicleType      String?
  fuelType         String?
  notes            String?
  periodMonth      Int?
  periodYear       Int?
  createdByUserId  String?
  updatedByUserId  String?
  isDeleted        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, scope, periodYear, periodMonth])
}

model User {
  id          Int                 @id @default(autoincrement())
  tenantId    String              @default("demo")
  email       String              @unique
  name        String
  passwordSHA String
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  memberships ProjectMembership[]
  userRoles   UserRole[]
  auditLogs   AuditLog[]

  @@index([tenantId, email])
}

model Role {
  id              Int              @id @default(autoincrement())
  tenantId        String           @default("demo")
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name], name: "tenantId_name")
  @@index([tenantId, name])
}

model Permission {
  id              Int              @id @default(autoincrement())
  tenantId        String           @default("demo")
  key             String
  label           String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@unique([tenantId, key])
  @@index([tenantId, key])
}

model UserRole {
  id       Int    @id @default(autoincrement())
  tenantId String @default("demo")
  userId   Int
  roleId   Int
  user     User   @relation(fields: [userId], references: [id])
  role     Role   @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, roleId], name: "tenantId_userId_roleId")
  @@index([tenantId, userId])
  @@index([tenantId, roleId])
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  tenantId     String     @default("demo")
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@unique([tenantId, roleId, permissionId])
  @@index([tenantId, roleId])
  @@index([tenantId, permissionId])
}

// Supplier Management
model Supplier {
  id               Int       @id @default(autoincrement())
  tenantId         String
  name             String
  status           String    @default("active")
  // Contact details (additive)
  email            String?
  phone            String?
  companyRegNo     String?
  vatNo            String?
  // Insurance details (additive)
  insurancePolicyNumber String?
  insuranceExpiry  DateTime?
  hsAccreditations String?
  performanceScore Decimal?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  capabilities    SupplierCapability[]
  invites         TenderInvite[]       @relation("SupplierInvites")
  submissions     Submission[]         @relation("SupplierSubmissions")
  contracts       Contract[]           @relation("SupplierContracts")
  awardedPackages Package[]            @relation("PackageAwardSupplier")
  invoices        Invoice[]
  onboardingTokens SupplierOnboardingToken[]

  @@index([tenantId, name])
  @@index([tenantId, status])
}

/// Token store for supplier self-onboarding links (additive)
model SupplierOnboardingToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  supplierId Int
  tenantId   String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([tenantId])
  @@index([expiresAt])
}

model SupplierCapability {
  id         Int      @id @default(autoincrement())
  supplierId Int
  tag        String
  tenantId   String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@index([tenantId, supplierId, tag])
}

model ProjectMembership {
  id        Int      @id @default(autoincrement())
  tenantId  String   @default("demo")
  projectId Int
  userId    Int
  role      String   @default("Member")
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([tenantId, projectId, userId], name: "tenantId_projectId_userId")
  @@index([tenantId, projectId])
  @@index([tenantId, userId])
}

model PurchaseOrder {
  id         Int        @id @default(autoincrement())
  tenantId   String     @default("demo")
  projectId  Int
  code       String
  supplier   String
  supplierId Int?
  status     String     @default("Open")
  orderDate  DateTime   @default(now())
  total      Decimal    @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  project    Project    @relation(fields: [projectId], references: [id])
  lines      POLine[]
  deliveries Delivery[]

  @@unique([tenantId, code])
  @@index([tenantId, projectId, status])
  @@index([tenantId, supplierId])
}

model POLine {
  id        Int           @id @default(autoincrement())
  tenantId  String        @default("demo")
  poId      Int
  item      String
  qty       Decimal       @default(0)
  unit      String
  unitCost  Decimal       @default(0)
  lineTotal Decimal       @default(0)
  po        PurchaseOrder @relation(fields: [poId], references: [id])

  @@index([tenantId, poId])
}

model Delivery {
  id         Int           @id @default(autoincrement())
  tenantId   String        @default("demo")
  poId       Int
  expectedAt DateTime
  receivedAt DateTime?
  note       String?
  po         PurchaseOrder @relation(fields: [poId], references: [id])

  @@index([tenantId, poId])
  @@index([poId, expectedAt])
}

// RFx / Tendering
model Request {
  id          Int       @id @default(autoincrement())
  tenantId    String
  title       String
  type        String    @default("RFP")
  status      String    @default("draft")
  deadline    DateTime?
  stage       Int       @default(1)
  totalStages Int       @default(1)
  weighting   Json?
  addenda     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Optional link to a procurement package when RFx is created from/for a package
  packageId   Int?
  package     Package?  @relation(fields: [packageId], references: [id])

  @@index([tenantId, status, deadline])
  @@index([tenantId, packageId, status])
}

model RequestSection {
  id        Int      @id @default(autoincrement())
  tenantId  String
  requestId Int
  title     String
  weight    Decimal?
  order     Int

  @@index([tenantId, requestId])
}

model RequestQuestion {
  id        Int      @id @default(autoincrement())
  tenantId  String
  requestId Int
  sectionId Int
  qType     String
  prompt    String
  required  Boolean  @default(false)
  options   Json?
  weight    Decimal?
  calc      Json?
  order     Int
}

model RequestInvite {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int
  email       String
  status      String    @default("invited")
  respondedAt DateTime?

  @@index([tenantId, requestId, status])
}

model RequestResponse {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int
  stage       Int
  answers     Json
  files       Json?
  submittedAt DateTime?
  score       Decimal?
  status      String    @default("in_progress")

  @@index([tenantId, requestId, supplierId, stage])
}

model RequestQna {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int?
  question    String
  answer      String?
  attachments Json?
  createdAt   DateTime  @default(now())
  answeredAt  DateTime?
}

model AwardDecision {
  id         Int       @id @default(autoincrement())
  tenantId   String
  requestId  Int
  supplierId Int
  decision   String    @default("pending")
  reason     String?
  decidedBy  Int?
  decidedAt  DateTime?

  @@index([tenantId, requestId, decision])
}

// Supplier Performance Management (SPM)
model SpmTemplate {
  id         Int      @id @default(autoincrement())
  tenantId   String
  name       String
  categories Json?
  kpis       Json?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
}

model SpmScorecard {
  id          Int      @id @default(autoincrement())
  tenantId    String
  supplierId  Int
  templateId  Int
  periodMonth String
  status      String   @default("open")
  totalScore  Decimal?
  createdAt   DateTime @default(now())

  @@index([tenantId, supplierId, periodMonth])
}

model SpmScore {
  id          Int      @id @default(autoincrement())
  tenantId    String
  scorecardId Int
  category    String
  kpi         String
  weight      Decimal
  value       Decimal?
  comment     String?
}

model BudgetLine {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  code        String?
  category    String?
  periodMonth String?
  description String?
  amount      Decimal  @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, periodMonth])
}

model Commitment {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  linkedPoId  Int?
  ref         String?
  supplier    String?
  description String?
  category    String?
  periodMonth String?
  amount      Decimal  @default(0)
  status      String   @default("Open")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, status])
  @@index([tenantId, projectId, periodMonth])
}

model ActualCost {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  ref         String?
  supplier    String?
  description String?
  category    String?
  amount      Decimal  @default(0)
  incurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  periodMonth String?

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, incurredAt])
  @@index([tenantId, projectId, periodMonth])
}

model Forecast {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  period      String
  periodMonth String?
  description String?
  amount      Decimal  @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@unique([tenantId, projectId, period])
  @@index([tenantId, projectId])
  @@index([tenantId, projectId, periodMonth])
}

model FinancialItem {
  id        Int      @id @default(autoincrement())
  tenantId  String
  projectId Int
  name      String
  amount    Decimal  @db.Decimal(18, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId])
}

// Invoices (project-scoped)
model Invoice {
  id         Int       @id @default(autoincrement())
  tenantId   String
  projectId  Int
  project    Project   @relation(fields: [projectId], references: [id])
  supplierId Int?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  number     String
  issueDate  DateTime?
  dueDate    DateTime?
  net        Decimal   @default(0)
  vat        Decimal   @default(0)
  gross      Decimal   @default(0)
  status     String    @default("Open")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([tenantId, projectId, status])
  @@index([tenantId, supplierId])
  @@index([tenantId, projectId, dueDate])
}

model Package {
  id              Int       @id @default(autoincrement())
  projectId       Int
  project         Project   @relation(fields: [projectId], references: [id])
  name            String
  scope           String?
  trade           String?
  status          String    @default("Draft")
  budgetEstimate  Decimal?
  deadline        DateTime?
  awardValue      Decimal?
  awardSupplierId Int?
  awardSupplier   Supplier? @relation("PackageAwardSupplier", fields: [awardSupplierId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  submissions Submission[]   @relation("PackageSubmissions")
  invites     TenderInvite[] @relation("PackageInvites")
  contract    Contract?      @relation("PackageContract")
  requests    Request[]

  @@index([projectId])
}

model TenderInvite {
  id          Int       @id @default(autoincrement())
  packageId   Int
  package     Package   @relation(name: "PackageInvites", fields: [packageId], references: [id])
  supplierId  Int
  supplier    Supplier  @relation("SupplierInvites", fields: [supplierId], references: [id])
  invitedAt   DateTime  @default(now())
  respondedAt DateTime?
  status      String    @default("Invited")

  submission Submission? @relation("TenderInviteSubmission")

  @@unique([packageId, supplierId])
  @@index([supplierId])
}

model Submission {
  id             Int      @id @default(autoincrement())
  packageId      Int
  package        Package  @relation(name: "PackageSubmissions", fields: [packageId], references: [id])
  supplierId     Int
  supplier       Supplier @relation("SupplierSubmissions", fields: [supplierId], references: [id])
  submittedAt    DateTime @default(now())
  price          Decimal?
  durationWeeks  Int?
  technicalScore Float?
  priceScore     Float?
  overallScore   Float?
  rank           Int?
  status         String   @default("Submitted")
  details        Json?

  invite TenderInvite? @relation("TenderInviteSubmission", fields: [packageId, supplierId], references: [packageId, supplierId])

  @@unique([packageId, supplierId])
  @@index([packageId])
  @@index([supplierId])
}

model Contract {
  id             BigInt    @id @default(autoincrement())
  projectId      Int
  project        Project   @relation(fields: [projectId], references: [id])
  packageId      Int?      @unique
  package        Package?  @relation(name: "PackageContract", fields: [packageId], references: [id])
  supplierId     Int
  supplier       Supplier  @relation("SupplierContracts", fields: [supplierId], references: [id])
  title          String
  contractNumber String?
  value          Decimal
  status         String    @default("Pending")
  signedAt       DateTime?
  startDate      DateTime?
  endDate        DateTime?
  retentionPct   Float?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([projectId])
  @@index([supplierId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  entity    String
  entityId  String
  action    String
  changes   Json?
  ipAddress String?

  @@index([entity, entityId])
}
