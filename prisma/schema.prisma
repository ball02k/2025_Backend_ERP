generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  shadowDatabaseUrl = env("PRISMA_MIGRATE_SHADOW_DATABASE_URL")
}

// ==========================================
// FLEXIBLE PRICING SYSTEM - ENUMS
// ==========================================

enum PricingMode {
  LUMP_SUM // Single price, no breakdown
  MEASURED // Full BOQ with unit rates required
  HYBRID // Package total + optional breakdown (recommended)
}

enum ResponsePricingType {
  LUMP_SUM_ONLY // Supplier provided package total only
  ITEMIZED_ONLY // Supplier provided full breakdown only
  HYBRID_WITH_BREAKDOWN // Supplier provided both total and breakdown
}

// Supplier Onboarding
model OnboardingProject {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  status    String   @default("draft")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
}

model OnboardingForm {
  id          Int     @id @default(autoincrement())
  tenantId    String
  projectId   Int
  title       String
  version     String  @default("v1")
  isPublished Boolean @default(false)
  sections    Json?

  @@index([tenantId, projectId])
}

model OnboardingInvite {
  id          Int       @id @default(autoincrement())
  tenantId    String
  projectId   Int
  supplierId  Int
  email       String
  token       String
  status      String    @default("invited")
  invitedAt   DateTime  @default(now())
  respondedAt DateTime?

  @@index([tenantId, projectId, status])
}

model OnboardingResponse {
  id          Int       @id @default(autoincrement())
  tenantId    String
  projectId   Int
  supplierId  Int? // link to Supplier when approved
  formId      Int
  answers     Json
  files       Json?
  status      String    @default("in_progress")
  submittedAt DateTime?
  reviewedBy  Int?
  reviewedAt  DateTime?
  decision    String?

  @@index([tenantId, projectId, supplierId, status])
}

model ProjectStatus {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectStatusRel")

  @@unique([tenantId, key])
}

model ProjectType {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  projects  Project[] @relation("ProjectTypeRel")

  @@unique([tenantId, key])
}

model TaskStatus {
  id        Int     @id @default(autoincrement())
  tenantId  Int?
  key       String
  label     String
  colorHex  String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  tasks     Task[]  @relation("TaskStatusRel")

  @@unique([tenantId, key])
}

model Client {
  id           Int       @id @default(autoincrement())
  name         String
  companyRegNo String?
  vatNo        String?
  address1     String?
  address2     String?
  city         String?
  county       String?
  postcode     String?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  projects     Project[]
  contacts     Contact[] // REQUIRED for includes/counts

  @@index([name])
  @@index([vatNo])
  @@index([companyRegNo])
}

model Project {
  id          Int     @id @default(autoincrement())
  tenantId    String  @default("demo")
  code        String  @unique
  name        String
  description String?

  clientId Int?
  client   Client? @relation(fields: [clientId], references: [id])

  // Legacy lookup relations (retain for compatibility)
  statusId  Int?
  statusRel ProjectStatus? @relation("ProjectStatusRel", fields: [statusId], references: [id])
  typeId    Int?
  typeRel   ProjectType?   @relation("ProjectTypeRel", fields: [typeId], references: [id])

  // Simple string fields for lean project
  status           String   @default("Active")
  type             String   @default("General")
  projectManagerId Int?
  country          String?
  currency         String?
  unitSystem       String?
  taxScheme        String?
  contractForm     String?
  // Additive project info fields
  clientContactId  Int?
  sitePostcode     String?
  siteLat          Decimal? @db.Decimal(10, 7)
  siteLng          Decimal? @db.Decimal(10, 7)
  // commercial basics (additive)
  contractType     String?
  paymentTermsDays Int?
  retentionPct     Decimal? @db.Decimal(5, 2)

  // internal roles (additive)
  projectManagerUserId   Int?
  quantitySurveyorUserId Int?
  startPlanned           DateTime?
  endPlanned             DateTime?
  startActual            DateTime?
  endActual              DateTime?
  labels                 Json?

  // Existing financial/schedule fields retained
  budget      Decimal?  @db.Decimal(18, 2)
  actualSpend Decimal?  @db.Decimal(18, 2)
  startDate   DateTime?
  endDate     DateTime?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tasks          Task[]
  variations     Variation[]
  snapshot       ProjectSnapshot?
  memberships    ProjectMembership[]
  purchaseOrders PurchaseOrder[]

  budgetLines    BudgetLine[]
  commitments    Commitment[]
  actualCosts    ActualCost[]
  forecasts      Forecast[]
  financialItems FinancialItem[]
  packages       Package[]
  contracts      Contract[]
  awards         Award[]
  invoices       Invoice[]
  awardDecisions AwardDecision[]
  rfx            Rfx[]

  // Back-relation for ImportJob → Project
  importJobs ImportJob[]

  // Additive relations to new modules
  rfis                  Rfi[]
  qaRecords             QaRecord[]
  hsEvents              HsEvent[]
  carbonEntries         CarbonEntry[]
  ApplicationForPayment ApplicationForPayment[]
  // MVP additive
  tenders               Tender[]

  // Additive relations for new info fields
  clientContact    Contact? @relation("Project_ClientContact", fields: [clientContactId], references: [id])
  // Disambiguate multiple relations to User
  projectManager   User?    @relation("Project_ProjectManager", fields: [projectManagerUserId], references: [id])
  quantitySurveyor User?    @relation("Project_QuantitySurveyor", fields: [quantitySurveyorUserId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, name])
  // Hot paths: client-filtered project lists and planned end sorting
  @@index([tenantId, clientId])
  @@index([tenantId, endPlanned])
  // Additive indexes for new info fields
  @@index([tenantId, clientContactId])
  @@index([tenantId, projectManagerUserId])
  @@index([tenantId, quantitySurveyorUserId])
}

model CostCode {
  id          Int      @id @default(autoincrement())
  tenantId    String
  code        String
  description String?
  parentId    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      CostCode?    @relation("CostCodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    CostCode[]   @relation("CostCodeHierarchy")
  budgetLines BudgetLine[]
  packages    Package[]

  @@unique([tenantId, code])
  @@index([tenantId, parentId])
}

model Task {
  id        Int     @id @default(autoincrement())
  projectId Int
  tenantId  String  @default("demo")
  project   Project @relation(fields: [projectId], references: [id])

  title       String
  description String?
  dueDate     DateTime?
  assignee    String?

  status String @default("Open")

  statusId  Int
  statusRel TaskStatus @relation("TaskStatusRel", fields: [statusId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, status])
  @@index([projectId, dueDate])
  @@index([tenantId, title])
}

model Contact {
  id       Int    @id @default(autoincrement())
  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  tenantId String @default("demo")

  firstName String
  lastName  String?
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Back-relation to projects where this contact is the client contact
  projectsAsClientContact Project[] @relation("Project_ClientContact")

  @@unique([clientId, email])
  @@index([tenantId, clientId])
  @@index([clientId, isPrimary])
  @@index([email])
  @@index([role])
}

model Variation {
  id           Int     @id @default(autoincrement())
  projectId    Int
  tenantId     String
  project      Project @relation(fields: [projectId], references: [id])
  packageId    Int?
  budgetLineId Int?
  contractId   Int?

  // Core identifiers
  reference     String? @db.VarChar(64)
  referenceCode String? @db.VarChar(64) // legacy
  title         String  @db.VarChar(255)
  description   String? @db.Text
  contractType  String  @db.VarChar(24)

  // Strings (avoid Prisma enums)
  type        String  @db.VarChar(24)
  status      String  @db.VarChar(24)
  reason      String? @db.VarChar(255)
  reason_code String? @db.VarChar(64) // legacy

  // Commercials
  // New spec fields
  amount         Decimal @default(0) @db.Decimal(18, 2)
  value          Decimal @db.Decimal(18, 2)
  costImpact     Decimal @db.Decimal(18, 2)
  timeImpactDays Int?
  notes          String?
  justification  String?

  // Legacy/computed fields retained for compatibility
  estimated_cost Decimal? @db.Decimal(18, 2)
  estimated_sell Decimal? @db.Decimal(18, 2)
  agreed_cost    Decimal? @db.Decimal(18, 2)
  agreed_sell    Decimal? @db.Decimal(18, 2)

  // Dates
  notifiedDate   DateTime?
  submittedDate  DateTime?
  submissionDate DateTime?
  decisionDate   DateTime?
  reviewedDate   DateTime?
  approvedDate   DateTime?
  approvedAt     DateTime?
  rejectedDate   DateTime?
  instructedDate DateTime?
  pricedDate     DateTime?
  agreedDate     DateTime?
  voIssuedDate   DateTime?
  voAcceptedDate DateTime?
  approvedBy     Int?

  // Meta
  is_deleted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  lines         VariationLine[]
  statusHistory VariationStatusHistory[]

  @@index([projectId])
  @@index([type])
  @@index([status])
  @@index([reference])
  @@index([referenceCode])
  @@index([tenantId, projectId])
  @@index([tenantId, status])
  @@index([tenantId, projectId, status])
  @@index([tenantId, projectId, status, updatedAt])
  @@index([tenantId, contractId])
  @@index([tenantId, budgetLineId])
  @@index([tenantId, packageId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([tenantId, title])
  @@index([tenantId, reference])
}

model VariationLine {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])
  tenantId    String

  cost_code   String?  @db.VarChar(64) // legacy
  description String   @db.VarChar(255)
  qty         Decimal  @db.Decimal(18, 3)
  rate        Decimal  @db.Decimal(18, 2)
  value       Decimal  @db.Decimal(18, 2)
  sort        Int      @default(0)
  unit        String?  @db.VarChar(32) // legacy
  unit_cost   Decimal? @db.Decimal(18, 2) // legacy
  unit_sell   Decimal? @db.Decimal(18, 2) // legacy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([variationId])
  @@index([tenantId])
}

model VariationStatusHistory {
  id          Int       @id @default(autoincrement())
  variationId Int
  variation   Variation @relation(fields: [variationId], references: [id])
  tenantId    String

  fromStatus String?  @db.VarChar(24)
  toStatus   String   @db.VarChar(24)
  note       String?  @db.VarChar(255)
  changedAt  DateTime @default(now())

  @@index([variationId])
  @@index([tenantId, variationId, changedAt])
}

model ProjectSnapshot {
  projectId Int    @id
  tenantId  String

  // Financial
  budget             Decimal? @db.Decimal(18, 2)
  committed          Decimal? @db.Decimal(18, 2)
  actual             Decimal? @db.Decimal(18, 2)
  retentionHeld      Decimal? @db.Decimal(18, 2)
  forecastAtComplete Decimal? @db.Decimal(18, 2)
  variance           Decimal? @db.Decimal(18, 2)

  financialBudget    Decimal @default(0)
  financialCommitted Decimal @default(0)
  financialActual    Decimal @default(0)
  financialForecast  Decimal @default(0)

  // Schedule
  schedulePct    Int?
  criticalAtRisk Int?

  // Variations
  variationsDraft         Int?
  variationsSubmitted     Int?
  variationsApproved      Int?
  variationsValueApproved Decimal? @db.Decimal(18, 2)

  // Tasks
  tasksOverdue     Int?
  tasksDueThisWeek Int?

  // RFIs (placeholder counts until RFI module lands)
  rfisOpen       Int?
  rfisAvgAgeDays Int?

  // QA/QC
  qaOpenNCR   Int?
  qaOpenPunch Int?

  // H&S
  hsIncidentsThisMonth Int?
  hsOpenPermits        Int?

  // Procurement
  procurementCriticalLate Int?
  procurementPOsOpen      Int?

  // Carbon
  carbonTarget Decimal? @db.Decimal(18, 2)
  carbonToDate Decimal? @db.Decimal(18, 2)
  carbonUnit   String?

  updatedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Document {
  id           BigInt         @id @default(autoincrement())
  tenantId     String
  filename     String
  mimeType     String
  size         Int
  storageKey   String         @unique
  sha256       String?
  uploadedAt   DateTime       @default(now())
  uploadedById String?
  links        DocumentLink[]

  @@index([tenantId])
  @@index([tenantId, uploadedAt])
}

model DocumentLink {
  id            Int      @id @default(autoincrement())
  tenantId      String
  documentId    BigInt
  projectId     Int?
  variationId   Int?
  // NEW optional link targets (additive)
  rfiId         Int?
  qaRecordId    Int?
  hsEventId     Int?
  carbonEntryId Int?
  poId          Int?
  linkType      String
  // Polymorphic linking (additive)
  // Allows generic linking to any entity type without adding columns per type
  entityType    String?
  entityId      Int?
  // Optional category for further grouping (e.g. 'spec', 'photo')
  category      String?
  createdAt     DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([tenantId, projectId])
  @@index([tenantId, variationId])
  @@index([tenantId, documentId])
  @@index([tenantId, entityType, entityId])
  @@index([projectId])
  @@index([variationId])
  @@index([tenantId, rfiId])
  @@index([tenantId, qaRecordId])
  @@index([tenantId, hsEventId])
  @@index([tenantId, carbonEntryId])
  @@index([tenantId, poId])
}

// --- Additive optional links to new modules ---
// Extend DocumentLink with nullable foreign keys to RFI/QA/H&S/Carbon entries
// Note: This is additive; existing behavior remains unchanged

/// NEW MODELS (Additive): RFI, QA/QC, H&S, Carbon

model Rfi {
  id                Int       @id @default(autoincrement())
  tenantId          String
  projectId         Int
  rfiNumber         String
  subject           String
  question          String
  status            String    @default("open")
  priority          String    @default("med")
  discipline        String?
  packageId         Int?
  requestedByUserId String?
  assignedToUserId  String?
  toCompanyId       Int?
  dueDate           DateTime?
  responseText      String?
  responseByUserId  String?
  respondedAt       DateTime?
  costImpact        String?
  scheduleImpact    String?
  changeRequired    Boolean?
  ccEmails          String?
  tags              String?
  location          String?
  originatorRef     String?
  closedAt          DateTime?
  voidReason        String?
  createdByUserId   String?
  updatedByUserId   String?
  isDeleted         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, status])
  @@index([tenantId, rfiNumber])
}

model QaRecord {
  id                 Int       @id @default(autoincrement())
  tenantId           String
  projectId          Int
  type               String
  title              String
  description        String?
  trade              String?
  location           String?
  lot                String?
  status             String    @default("open")
  raisedByUserId     String?
  assignedToUserId   String?
  dueDate            DateTime?
  itpRef             String?
  testMethod         String?
  acceptanceCriteria String?
  remedialAction     String?
  targetClose        DateTime?
  closedAt           DateTime?
  tags               String?
  reference          String?
  createdByUserId    String?
  updatedByUserId    String?
  isDeleted          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  project Project  @relation(fields: [projectId], references: [id])
  items   QaItem[]

  @@index([tenantId, projectId, status, type])
}

model QaItem {
  id               Int       @id @default(autoincrement())
  tenantId         String
  qaRecordId       Int
  item             String
  result           String    @default("open")
  notes            String?
  responsibleParty String?
  dueDate          DateTime?
  closedAt         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  record QaRecord @relation(fields: [qaRecordId], references: [id])

  @@index([tenantId, qaRecordId])
}

model HsEvent {
  id                 Int       @id @default(autoincrement())
  tenantId           String
  projectId          Int
  type               String
  title              String
  description        String
  eventDate          DateTime
  location           String?
  reportedByUserId   String?
  assignedToUserId   String?
  status             String    @default("open")
  severity           String?
  initialRiskRating  String?
  residualRiskRating String?
  personsInvolved    Json?
  lostTimeHours      Int?
  isRIDDOR           Boolean?
  riddorRef          String?
  regulatorNotified  Boolean?
  regulatorName      String?
  notificationDate   DateTime?
  immediateAction    String?
  rootCause          String?
  correctiveActions  String?
  targetClose        DateTime?
  closedAt           DateTime?
  tags               String?
  createdByUserId    String?
  updatedByUserId    String?
  isDeleted          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, type, status])
}

model CarbonEntry {
  id               Int      @id @default(autoincrement())
  tenantId         String
  projectId        Int
  scope            String
  category         String
  activityDate     DateTime
  quantity         Decimal  @db.Decimal(18, 6)
  unit             String
  emissionFactor   Decimal  @db.Decimal(18, 6)
  factorUnit       String
  calculatedKgCO2e Decimal  @db.Decimal(18, 6)
  supplierId       Int?
  purchaseOrderId  Int?
  poLineId         Int?
  deliveryId       Int?
  factorSource     String?
  factorRef        String?
  materialOrFuel   String?
  vehicleType      String?
  fuelType         String?
  notes            String?
  periodMonth      Int?
  periodYear       Int?
  createdByUserId  String?
  updatedByUserId  String?
  isDeleted        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, scope, periodYear, periodMonth])
}

model User {
  id          Int                 @id @default(autoincrement())
  tenantId    String              @default("demo")
  email       String              @unique
  name        String
  passwordSHA String
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  memberships ProjectMembership[]
  userRoles   UserRole[]

  // Back-relations to projects for role assignments
  projectsManaged        Project[] @relation("Project_ProjectManager")
  projectsQuantitySurvey Project[] @relation("Project_QuantitySurveyor")

  // Back-relations for Package relations
  ownedPackages  Package[] @relation("PackageOwnerUser")
  buyingPackages Package[] @relation("PackageBuyerUser")

  // Back-relation for TenderInvitation
  sentTenderInvitations TenderInvitation[] @relation("TenderInvitationInvitedBy")

  @@index([tenantId, email])
}

model Role {
  id              Int              @id @default(autoincrement())
  tenantId        String           @default("demo")
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name], name: "tenantId_name")
  @@index([tenantId, name])
}

model Permission {
  id              Int              @id @default(autoincrement())
  tenantId        String           @default("demo")
  key             String
  label           String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@unique([tenantId, key])
  @@index([tenantId, key])
}

model UserRole {
  id       Int    @id @default(autoincrement())
  tenantId String @default("demo")
  userId   Int
  roleId   Int
  user     User   @relation(fields: [userId], references: [id])
  role     Role   @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, roleId], name: "tenantId_userId_roleId")
  @@index([tenantId, userId])
  @@index([tenantId, roleId])
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  tenantId     String     @default("demo")
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@unique([tenantId, roleId, permissionId])
  @@index([tenantId, roleId])
  @@index([tenantId, permissionId])
}

// Supplier Management
model Supplier {
  id                    Int       @id @default(autoincrement())
  tenantId              String
  name                  String
  status                String    @default("active")
  // Contact details (additive)
  email                 String?
  phone                 String?
  companyRegNo          String?
  vatNo                 String?
  // Insurance details (additive)
  insurancePolicyNumber String?
  insuranceExpiry       DateTime?
  hsAccreditations      String?
  performanceScore      Decimal?
  complianceStatus      String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  capabilities          SupplierCapability[]
  invites               TenderInvite[]            @relation("SupplierInvites")
  submissions           Submission[]              @relation("SupplierSubmissions")
  // Additive relations for tendering module
  tenderInvites         TenderSupplierInvite[]
  tenderResponses       TenderResponse[]
  tenderSubmissions     TenderSubmission[]        @relation("TenderSubmissionSupplier")
  contracts             Contract[]
  awards                Award[]
  awardDecisions        AwardDecision[]
  complianceOverrides   ComplianceOverride[]
  awardedPackages       Package[]                 @relation("PackageAwardSupplier")
  awardedToPackages     Package[]                 @relation("PackageAwardedToSupplier")
  invoices              Invoice[]
  onboardingTokens      SupplierOnboardingToken[]
  ApplicationForPayment ApplicationForPayment[]
  packageResponses      PackageResponse[]
  tenderInvitations     TenderInvitation[]        @relation("TenderInvitationSupplier")

  @@index([tenantId, name])
  @@index([tenantId, status])
}

/// Token store for supplier self-onboarding links (additive)
model SupplierOnboardingToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  supplierId Int
  tenantId   String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([tenantId])
  @@index([expiresAt])
}

model SupplierCapability {
  id         Int      @id @default(autoincrement())
  supplierId Int
  tag        String
  tenantId   String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@index([tenantId, supplierId, tag])
}

model ProjectMembership {
  id        Int      @id @default(autoincrement())
  tenantId  String   @default("demo")
  projectId Int
  userId    Int
  role      String   @default("Member")
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([tenantId, projectId, userId], name: "tenantId_projectId_userId")
  @@index([tenantId, projectId])
  @@index([tenantId, userId])
}

model PurchaseOrder {
  id         Int        @id @default(autoincrement())
  tenantId   String     @default("demo")
  projectId  Int
  code       String
  supplier   String
  supplierId Int?
  contractId Int?
  status     String     @default("Open")
  orderDate  DateTime   @default(now())
  total      Decimal    @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  project    Project    @relation(fields: [projectId], references: [id])
  contract   Contract?  @relation(fields: [contractId], references: [id])
  lines      POLine[]
  deliveries Delivery[]

  @@unique([tenantId, code])
  @@index([tenantId, projectId, status])
  @@index([tenantId, supplierId])
  @@index([tenantId, contractId])
}

model POLine {
  id        Int           @id @default(autoincrement())
  tenantId  String        @default("demo")
  poId      Int
  item      String
  qty       Decimal       @default(0)
  unit      String
  unitCost  Decimal       @default(0)
  lineTotal Decimal       @default(0)
  po        PurchaseOrder @relation(fields: [poId], references: [id])

  @@index([tenantId, poId])
}

model Delivery {
  id         Int           @id @default(autoincrement())
  tenantId   String        @default("demo")
  poId       Int
  expectedAt DateTime
  receivedAt DateTime?
  note       String?
  po         PurchaseOrder @relation(fields: [poId], references: [id])

  @@index([tenantId, poId])
  @@index([poId, expectedAt])
}

// RFx / Tendering
model Request {
  id          Int       @id @default(autoincrement())
  tenantId    String
  title       String
  type        String    @default("RFP")
  status      String    @default("draft") // "draft" | "live" | "closed" | "awarded"
  deadline    DateTime?
  issuedAt    DateTime?
  stage       Int       @default(1)
  totalStages Int       @default(1)
  weighting   Json?
  addenda     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Optional link to a procurement package when RFx is created from/for a package
  packageId Int?
  package   Package? @relation(fields: [packageId], references: [id])

  @@index([tenantId, status, deadline])
  @@index([tenantId, packageId, status])
}

model Rfx {
  id          Int       @id @default(autoincrement())
  tenantId    String
  projectId   Int
  packageId   Int?
  title       String
  description String?
  deadline    DateTime?
  budget      Decimal?  @db.Decimal(18, 2)
  status      String    @default("draft") // draft, live, evaluating, awarded, closed
  reviewers   String? // JSON string of user IDs or names
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project      Project        @relation(fields: [projectId], references: [id])
  package      Package?       @relation(fields: [packageId], references: [id])
  rfxSection   RfxSection[]
  rfxQuestion  RfxQuestion[]
  rfxCriterion RfxCriterion[]
  rfxInvite    RfxInvite[]
  rfxResponse  RfxResponse[]
  rfxQna       RfxQna[]
  contract     Contract?      @relation("ContractRfx")

  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
}

// Additive: RFx submission payloads for XML flows (Spreadsheet import)
model RfxResponse {
  id         Int      @id @default(autoincrement())
  tenantId   String
  rfxId      Int
  supplierId Int
  // Parsed payloads
  pricing    Json?
  answers    Json?
  score      Decimal? @db.Decimal(8, 2)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  rfx Rfx @relation(fields: [rfxId], references: [id])

  @@unique([tenantId, rfxId, supplierId], name: "tenantId_rfxId_supplierId")
  @@index([tenantId, rfxId])
  @@index([tenantId, supplierId])
  @@map("RFxSubmission")
}

model RequestSection {
  id        Int      @id @default(autoincrement())
  tenantId  String
  requestId Int
  title     String
  weight    Decimal?
  order     Int

  @@index([tenantId, requestId])
}

model RequestQuestion {
  id               Int      @id @default(autoincrement())
  tenantId         String
  requestId        Int
  sectionId        Int?
  qType            String
  prompt           String
  required         Boolean  @default(false)
  options          Json?
  weight           Decimal?
  calc             Json?
  order            Int
  helpText         String?  @db.Text
  referenceDocUrl  String?
  referenceDocName String?
  scoringCriteria  String?  @db.Text
}

model RequestInvite {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int
  email       String
  status      String    @default("invited")
  respondedAt DateTime?

  @@index([tenantId, requestId, status])
}

model RequestResponse {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int
  stage       Int
  answers     Json
  files       Json?
  submittedAt DateTime?
  score       Decimal?
  status      String    @default("in_progress")

  @@index([tenantId, requestId, supplierId, stage])
}

model RequestQna {
  id          Int       @id @default(autoincrement())
  tenantId    String
  requestId   Int
  supplierId  Int?
  question    String
  answer      String?
  attachments Json?
  createdAt   DateTime  @default(now())
  answeredAt  DateTime?
}

/// ===============================
/// Tender/Award/Contracts (Additive)
/// ===============================

model Trade {
  id        Int      @id @default(autoincrement())
  name      String
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, name])
}

/// Snapshot of budget lines added into a package at the time of selection.
/// We intentionally keep a loose link to the source (budgetLineItemId) without a relation
/// to avoid coupling migrations. Quantities/rates are snapshotted for auditability.
model PackageLineItem {
  id               Int  @id @default(autoincrement())
  packageId        Int
  budgetLineItemId Int?

  // Line item identification (NEW for BOQ)
  itemNumber String? // e.g., "1.1", "2.3.4"
  section    String? // e.g., "Excavation", "Concrete Work"

  description   String  @db.Text
  specification String? @db.Text // NEW: Detailed spec

  // Quantities (keeping existing fields + adding unit)
  qty      Decimal  @db.Decimal(18, 4)
  quantity Decimal? @db.Decimal(18, 4) // Alias for qty (for BOQ compatibility)
  unit     String? // NEW: m³, m², m, nr, t, kg, item, sum

  // Rates and totals
  rate  Decimal @db.Decimal(18, 4)
  total Decimal @db.Decimal(18, 2)

  // Buyer's estimate (NEW - optional, not visible to suppliers)
  estimatedRate  Decimal? @db.Decimal(18, 4)
  estimatedTotal Decimal? @db.Decimal(18, 2)

  // Display & validation (NEW for BOQ)
  displayOrder     Int     @default(0)
  isMandatory      Boolean @default(true) // Can supplier skip this?
  allowAlternative Boolean @default(false) // Can supplier propose alternative?

  // Reference documents (NEW)
  referenceDrawing String? // Drawing number reference
  referenceSpec    String? // Spec section reference

  costCode   String?
  snapshotAt DateTime @default(now())
  tenantId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  Int? // NEW: User who created

  // relations (safe assumptions: Package exists)
  package        Package             @relation(fields: [packageId], references: [id])
  contractLines  ContractLineItem[]  @relation("PackageLineContractLines")
  supplierPrices SupplierLinePrice[] // NEW: Supplier pricing for this line

  @@index([tenantId, packageId])
  @@index([tenantId, costCode])
  @@index([itemNumber])
  @@index([displayOrder])
}

/// An award decision created from Direct Award or Tender evaluation.
/// decision: 'approved' | 'approved_with_override' | 'rejected' (stored as String)
model AwardDecision {
  id          Int      @id @default(autoincrement())
  projectId   Int
  packageId   Int
  supplierId  Int?
  awardType   String // 'direct' | 'tender'
  decision    String // as above, string (no enums)
  reason      String?
  decidedById Int? // store user id scalar; avoid relation to keep additive safety
  decidedAt   DateTime @default(now())
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations (safe assumptions: Project, Package, Supplier exist)
  project  Project   @relation(fields: [projectId], references: [id])
  package  Package   @relation(fields: [packageId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
  @@index([tenantId, supplierId])
  @@index([tenantId, awardType])
  @@index([tenantId, decision])
}

/// If compliance fails but user overrides, we capture the reason.
/// This does not change compliance data; it documents governance.
model ComplianceOverride {
  id          Int      @id @default(autoincrement())
  supplierId  Int
  packageId   Int?
  reason      String
  createdById Int? // store user id scalar
  createdAt   DateTime @default(now())
  tenantId    String

  // relations
  supplier Supplier @relation(fields: [supplierId], references: [id])
  package  Package? @relation(fields: [packageId], references: [id])

  @@index([tenantId, supplierId])
  @@index([tenantId, packageId])
}

// Supplier Performance Management (SPM)
model SpmTemplate {
  id         Int      @id @default(autoincrement())
  tenantId   String
  name       String
  categories Json?
  kpis       Json?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
}

model SpmScorecard {
  id          Int      @id @default(autoincrement())
  tenantId    String
  supplierId  Int
  templateId  Int
  periodMonth String
  status      String   @default("open")
  totalScore  Decimal?
  createdAt   DateTime @default(now())

  @@index([tenantId, supplierId, periodMonth])
}

model SpmScore {
  id          Int      @id @default(autoincrement())
  tenantId    String
  scorecardId Int
  category    String
  kpi         String
  weight      Decimal
  value       Decimal?
  comment     String?
}

model BudgetLine {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  code        String?
  category    String?
  periodMonth String?
  description String?
  qty         Decimal  @default(0) @db.Decimal(18, 2)
  unit        String?
  rate        Decimal  @default(0) @db.Decimal(18, 4)
  total       Decimal  @default(0) @db.Decimal(18, 2)
  amount      Decimal  @default(0)
  planned     Decimal? @db.Decimal(18, 2)
  estimated   Decimal? @db.Decimal(18, 2)
  actual      Decimal? @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  costCodeId  Int?
  // Grouping (additive)
  groupId     Int?
  sortOrder   Int?     @default(0)
  position    Int      @default(0)

  project       Project            @relation(fields: [projectId], references: [id])
  costCode      CostCode?          @relation(fields: [costCodeId], references: [id], onDelete: SetNull)
  group         BudgetGroup?       @relation(fields: [groupId], references: [id])
  // Link budget lines to procurement packages
  packageItems  PackageItem[]
  contractLines ContractLineItem[] @relation("BudgetLineContractLines")

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, periodMonth])
  @@index([tenantId, costCodeId])
  @@index([tenantId, groupId])
}

// Budget line grouping (system/user groups)
model BudgetGroup {
  id        Int      @id @default(autoincrement())
  tenantId  String   @default("demo")
  projectId Int
  name      String
  sortOrder Int      @default(0)
  position  Int      @default(0)
  isSystem  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Opposite relation for BudgetLine.group
  budgetLines BudgetLine[]

  @@index([tenantId, projectId])
}

model Commitment {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  linkedPoId  Int?
  ref         String?
  supplier    String?
  description String?
  category    String?
  periodMonth String?
  amount      Decimal  @default(0)
  status      String   @default("Open")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, status])
  @@index([tenantId, projectId, periodMonth])
}

model ActualCost {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  ref         String?
  supplier    String?
  description String?
  category    String?
  amount      Decimal  @default(0)
  incurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  periodMonth String?

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId, incurredAt])
  @@index([tenantId, projectId, periodMonth])
}

model Forecast {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  projectId   Int
  period      String
  periodMonth String?
  description String?
  amount      Decimal  @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@unique([tenantId, projectId, period])
  @@index([tenantId, projectId])
  @@index([tenantId, projectId, periodMonth])
}

model FinancialItem {
  id        Int      @id @default(autoincrement())
  tenantId  String
  projectId Int
  name      String
  amount    Decimal  @db.Decimal(18, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId])
}

// Invoices (project-scoped)
model Invoice {
  id            Int       @id @default(autoincrement())
  tenantId      String
  projectId     Int
  project       Project   @relation(fields: [projectId], references: [id])
  supplierId    Int?
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  number        String
  issueDate     DateTime?
  dueDate       DateTime?
  net           Decimal   @default(0)
  vat           Decimal   @default(0)
  gross         Decimal   @default(0)
  status        String    @default("Open")
  // Additive finance fields
  documentId    BigInt?
  ocrStatus     String?
  ocrResultJson Json?
  poNumberRef   String?
  matchStatus   String?
  matchedPoId   Int?
  source        String?
  // Additive links to tie into budget/contract rollups
  packageId     Int?
  contractId    Int?
  contract      Contract? @relation(fields: [contractId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId, projectId, status])
  @@index([tenantId, supplierId])
  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
  @@index([tenantId, contractId])
  @@index([tenantId, projectId, dueDate])
  @@index([tenantId, projectId, source])
}

/// Finance: Invoice line items (additive)
model InvoiceLine {
  id          Int     @id @default(autoincrement())
  tenantId    String  @default("demo")
  invoiceId   Int
  lineNo      Int
  description String
  costCode    String?
  qty         Decimal @default(0)
  unit        String?
  rate        Decimal @default(0)
  vatRatePct  Float?
  totalExVat  Decimal @default(0)
  totalVat    Decimal @default(0)
  totalIncVat Decimal @default(0)

  @@index([tenantId, invoiceId])
}

/// Finance: Matching records (additive)
model FinanceMatch {
  id            Int      @id @default(autoincrement())
  tenantId      String   @default("demo")
  type          String // po_invoice|po_receipt|invoice_receipt|three_way
  status        String // proposed|accepted|rejected
  reason        String?
  varianceExVat Decimal? @default(0)
  varianceVat   Decimal? @default(0)
  varianceTotal Decimal? @default(0)
  toleranceUsed Decimal? @default(0)
  poId          Int?
  invoiceId     Int?
  receiptId     Int?
  createdAt     DateTime @default(now())
  createdById   Int?

  @@index([tenantId, type, status])
  @@index([tenantId, poId])
  @@index([tenantId, invoiceId])
}

/// Finance: Inbound email storage (additive)
model InboundEmail {
  id         Int      @id @default(autoincrement())
  tenantId   String   @default("demo")
  inbox      String
  fromAddr   String
  subject    String?
  bodyText   String?
  rawId      String?
  receivedAt DateTime @default(now())
  invoiceId  Int?
  status     String   @default("stored")
  error      String?

  attachments EmailAttachment[]

  @@index([tenantId, inbox, receivedAt])
}

model EmailAttachment {
  id             Int          @id @default(autoincrement())
  inboundEmailId Int
  inboundEmail   InboundEmail @relation(fields: [inboundEmailId], references: [id])
  filename       String
  mimeType       String?
  size           Int?
  documentId     BigInt?
}

// --- Applications for Payment (AfP) ---
model ApplicationForPayment {
  id              Int       @id @default(autoincrement())
  tenantId        String
  projectId       Int
  supplierId      Int?
  contractId      Int?
  applicationNo   String // e.g. "AFP-2025-00012", unique per tenant
  applicationDate DateTime // date submitted
  periodStart     DateTime
  periodEnd       DateTime
  assessmentDate  DateTime? // JCT IVD / NEC assessment date
  dueDate         DateTime? // contractual due date for payment
  currency        String // "GBP" default
  // Claimed
  grossToDate     Decimal   @db.Decimal(18, 2)
  variationsValue Decimal   @db.Decimal(18, 2)
  prelimsValue    Decimal   @db.Decimal(18, 2)
  retentionValue  Decimal   @db.Decimal(18, 2)
  mosValue        Decimal   @db.Decimal(18, 2) // materials on site
  offsiteValue    Decimal   @db.Decimal(18, 2) // materials off site
  deductionsValue Decimal   @db.Decimal(18, 2) // contra charges etc.
  netClaimed      Decimal   @db.Decimal(18, 2)

  // Certification
  certifiedAmount    Decimal?  @db.Decimal(18, 2)
  certifiedDate      DateTime?
  certifiedByUserId  Int?
  certificationNotes String?

  // Notices timeline
  paymentNoticeIssuedAt DateTime?
  payLessNoticeIssuedAt DateTime?
  payLessReason         String?

  status    String // draft | submitted | payment_notice | pay_less_notice | certified | rejected | paid
  reference String? // free text: invoice ref, CA note etc.
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project       Project         @relation(fields: [projectId], references: [id])
  supplier      Supplier?       @relation(fields: [supplierId], references: [id])
  contract      Contract?       @relation(fields: [contractId], references: [id])
  AfpAttachment AfpAttachment[]

  @@unique([tenantId, applicationNo])
  @@index([tenantId, projectId, applicationDate])
  @@index([tenantId, supplierId])
  @@index([tenantId, status])
}

model AfpAttachment {
  id         Int      @id @default(autoincrement())
  tenantId   String
  afpId      Int
  documentId BigInt
  label      String?
  createdAt  DateTime @default(now())

  afp ApplicationForPayment @relation(fields: [afpId], references: [id])
  // Document.id remains BigInt elsewhere
}

/// Finance: OCR job queue (additive)
model OcrJob {
  id         Int      @id @default(autoincrement())
  tenantId   String   @default("demo")
  documentId BigInt
  kind       String   @default("invoice") // invoice|po
  status     String   @default("queued") // queued|processing|done|failed
  provider   String?
  resultJson Json?
  error      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  invoiceId  Int?
  poId       Int?

  @@index([tenantId, status])
}

// Feature flags removed by Task-14 rollback: FeatureGrant model deleted

model Package {
  id                  Int       @id @default(autoincrement())
  projectId           Int
  project             Project   @relation(fields: [projectId], references: [id])
  name                String
  scopeSummary        String?   @map("scope")
  trade               String?
  status              String    @default("Draft")
  budgetEstimate      Decimal?
  deadline            DateTime?
  // Additional scheduling + info fields
  targetAwardDate     DateTime?
  requiredOnSite      DateTime?
  leadTimeWeeks       Int?
  contractForm        String?
  retentionPct        Decimal?  @db.Decimal(5, 2)
  paymentTerms        String?
  currency            String?
  awardValue          Decimal?
  awardSupplierId     Int?
  awardSupplier       Supplier? @relation("PackageAwardSupplier", fields: [awardSupplierId], references: [id])
  awardedToSupplierId Int?
  awardedToSupplier   Supplier? @relation("PackageAwardedToSupplier", fields: [awardedToSupplierId], references: [id])
  awardedValue        Decimal?  @db.Decimal(18, 2)
  awardedAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  costCodeId          Int?
  // New additive fields for tender packaging
  attachments         Json?
  // Optional: explicitly store a trade category label
  tradeCategory       String?
  // Ownership (optional)
  ownerUserId         Int?
  buyerUserId         Int?
  ownerUser           User?     @relation("PackageOwnerUser", fields: [ownerUserId], references: [id])
  buyerUser           User?     @relation("PackageBuyerUser", fields: [buyerUserId], references: [id])

  // NEW PRICING FIELDS:
  pricingMode        PricingMode @default(HYBRID)
  breakdownMandatory Boolean     @default(false) // For HYBRID mode: require breakdown?
  estimatedValue     Decimal? // Internal budget estimate (can alias budgetEstimate)
  budgetValue        Decimal? // Approved budget for this package
  createdBy          Int? // User who created the package

  submissions         Submission[]         @relation("PackageSubmissions")
  invites             TenderInvite[]       @relation("PackageInvites")
  contracts           Contract[]
  requests            Request[]
  tenders             Tender[]
  rfx                 Rfx[]
  costCode            CostCode?            @relation(fields: [costCodeId], references: [id], onDelete: SetNull)
  // Link to selected budget lines
  budgetItems         PackageItem[]
  lineItems           PackageLineItem[]
  awardDecisions      AwardDecision[]
  complianceOverrides ComplianceOverride[]
  awards              Award[]
  packageResponses    PackageResponse[]

  @@index([projectId])
  @@index([projectId, costCodeId])
  @@index([projectId, status])
}

// Join model linking packages to budget lines
model PackageItem {
  id           Int      @id @default(autoincrement())
  tenantId     String   @default("demo")
  packageId    Int
  budgetLineId Int
  createdAt    DateTime @default(now())

  package    Package    @relation(fields: [packageId], references: [id])
  budgetLine BudgetLine @relation(fields: [budgetLineId], references: [id])

  @@index([tenantId, packageId])
  @@index([tenantId, budgetLineId])
}

// Additive lightweight tendering models (separate from existing Request/Submission)
model Tender {
  id              Int       @id @default(autoincrement())
  tenantId        String    @default("demo")
  projectId       Int
  packageId       Int?
  title           String
  description     String?
  status          String
  // Additive fields for consolidated tenders list
  deadlineAt      DateTime?
  invitedCount    Int       @default(0)
  submissionCount Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project   Project                @relation(fields: [projectId], references: [id])
  package   Package?               @relation(fields: [packageId], references: [id])
  bids      TenderBid[]
  // Additive relations for questions, responses, and invites
  sections  TenderSection[]
  questions TenderQuestion[]
  responses TenderResponse[]
  invites   TenderSupplierInvite[]

  @@unique([id, tenantId], name: "id_tenantId")
  @@index([tenantId, projectId])
}

// Additive: sections organize questions into groups
model TenderSection {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  tenderId    Int
  name        String
  description String?
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())

  tender    Tender           @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  questions TenderQuestion[]

  @@index([tenantId, tenderId])
}

// Additive: questions for tender scoring
model TenderQuestion {
  id        Int    @id @default(autoincrement())
  tenantId  String @default("demo")
  tenderId  Int
  sectionId Int? // Link to section for grouping
  text      String
  type      String // 'text' | 'textarea' | 'number' | 'single' | 'multi' | 'file' | 'yes_no' | 'dropdown' | 'checkboxes' | 'date' | 'currency' | 'rating'
  weight    Float // Can be used as maxScore for scoring
  options   Json? // For multiple choice/checkboxes/dropdown

  // Enhanced fields for better questionnaire building
  isRequired       Boolean  @default(false)
  helpText         String?
  orderIndex       Int      @default(0)
  referenceDocUrl  String? // URL to reference document (specs, drawings, etc.)
  referenceDocName String? // Display name for reference doc
  scoringCriteria  String? // How to score this question
  createdAt        DateTime @default(now())

  tender  Tender         @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  section TenderSection? @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([tenantId, tenderId])
  @@index([tenantId, sectionId])
}

// Additive: token-based invites per tender (distinct from legacy package invites)
model TenderSupplierInvite {
  id          Int      @id @default(autoincrement())
  tenantId    String   @default("demo")
  tenderId    Int
  supplierId  Int
  inviteToken String   @unique
  status      String   @default("invited") // invited | responded | withdrawn
  createdAt   DateTime @default(now())

  tender   Tender   @relation(fields: [tenderId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([tenantId, tenderId, supplierId])
}

// Additive: supplier response to a tender
model TenderResponse {
  id           Int      @id @default(autoincrement())
  tenantId     String   @default("demo")
  tenderId     Int
  supplierId   Int
  priceTotal   Decimal  @db.Decimal(18, 2)
  leadTimeDays Int?
  submittedAt  DateTime @default(now())
  answers      Json
  autoScore    Float    @default(0)
  manualScore  Float    @default(0)
  notes        String?

  // Additive fields for buyer-entered responses and file attachments
  source      String @default("supplier") // 'supplier' | 'buyer'
  attachments Json?

  // NEW PRICING FIELDS:
  totalBidValue Decimal? @db.Decimal(18, 2) // Overall bid value (sum of all packages)

  tender   Tender   @relation(fields: [tenderId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  // NEW RELATIONS:
  packageResponses PackageResponse[]

  @@index([tenantId, tenderId, supplierId])
}

// ==========================================
// NEW MODEL: PACKAGE RESPONSE (supplier pricing per package)
// ==========================================

model PackageResponse {
  id               Int    @id @default(autoincrement())
  tenantId         String
  packageId        Int
  tenderResponseId Int
  supplierId       Int

  // Pricing approach chosen by supplier
  pricingType ResponsePricingType

  // PACKAGE-LEVEL PRICING (always required)
  packageTotal Decimal @db.Decimal(18, 2)

  // COMMERCIAL TERMS
  preliminaries         Decimal? @db.Decimal(18, 2)
  prelimsPercentage     Decimal? @db.Decimal(5, 2)
  contingency           Decimal? @db.Decimal(18, 2)
  contingencyPercentage Decimal? @db.Decimal(5, 2)
  overheadsProfit       Decimal? @db.Decimal(18, 2)
  overheadsProfitPerc   Decimal? @db.Decimal(5, 2)

  // PROGRAMME
  programmeDuration Int? // Days to complete
  startDate         DateTime?
  completionDate    DateTime?
  keyMilestones     Json? // Array of milestone objects

  // COMMERCIAL DETAILS
  paymentTerms        String?  @db.Text
  retentionPercentage Decimal? @db.Decimal(5, 2)
  retentionAmount     Decimal? @db.Decimal(18, 2)
  defectsLiability    Int? // Months
  warranties          String?  @db.Text
  bondRequired        Boolean  @default(false)
  bondPercentage      Decimal? @db.Decimal(5, 2)
  insuranceDetails    String?  @db.Text

  // SUPPLIER QUALIFICATIONS & NOTES
  assumptions    Json? // Array of assumption strings
  exclusions     Json? // Array of exclusion strings
  clarifications Json? // Array of clarification strings
  alternatives   Json? // Alternative proposals/VE options

  // TECHNICAL COMPLIANCE
  technicalCompliance Boolean?
  complianceNotes     String?  @db.Text
  deviations          Json? // Array of deviation objects

  // RESOURCE ALLOCATION
  keyPersonnel   Json? // Array of personnel objects
  subcontractors Json? // Array of proposed subcontractors
  plantEquipment Json? // Major plant/equipment list

  // QUALITY & SAFETY
  qualityPlan     String? @db.Text
  safetyPlan      String? @db.Text
  methodStatement String? @db.Text

  // ATTACHMENTS
  attachments Json? // Array of document references

  // SUBMISSION TRACKING
  status      String    @default("draft") // draft, submitted, under_review, accepted, rejected, withdrawn
  lastSavedAt DateTime  @default(now())
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  Int?

  // EVALUATION
  technicalScore  Decimal? @db.Decimal(5, 2)
  commercialScore Decimal? @db.Decimal(5, 2)
  programmeScore  Decimal? @db.Decimal(5, 2)
  totalScore      Decimal? @db.Decimal(5, 2)
  evaluationNotes String?  @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  package        Package             @relation(fields: [packageId], references: [id], onDelete: Cascade)
  tenderResponse TenderResponse      @relation(fields: [tenderResponseId], references: [id], onDelete: Cascade)
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  lineItemPrices SupplierLinePrice[]

  @@unique([packageId, tenderResponseId])
  @@index([tenantId, packageId])
  @@index([tenantId, tenderResponseId])
  @@index([supplierId])
  @@index([status])
}

// ==========================================
// NEW MODEL: SUPPLIER LINE ITEM PRICING (optional breakdown)
// ==========================================

model SupplierLinePrice {
  id                Int    @id @default(autoincrement())
  tenantId          String
  packageResponseId Int
  lineItemId        Int

  // Pricing
  rate  Decimal? @db.Decimal(18, 4) // Unit rate (null if lump sum item)
  total Decimal  @db.Decimal(18, 2) // Line total (always required)

  // Supplier notes per line
  notes         String? @db.Text
  alternative   String? @db.Text // Alternative proposal for this specific item
  specification String? @db.Text // Proposed spec/product for this item

  // Build-up (for transparency)
  labourCost      Decimal? @db.Decimal(18, 2)
  materialCost    Decimal? @db.Decimal(18, 2)
  plantCost       Decimal? @db.Decimal(18, 2)
  subcontractCost Decimal? @db.Decimal(18, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  packageResponse PackageResponse @relation(fields: [packageResponseId], references: [id], onDelete: Cascade)
  lineItem        PackageLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)

  @@unique([packageResponseId, lineItemId])
  @@index([tenantId, packageResponseId])
  @@index([lineItemId])
}

// ==========================================
// AUDIT LOG FOR PRICING CHANGES
// ==========================================

model PackagePricingAuditLog {
  id                Int    @id @default(autoincrement())
  tenantId          String
  packageResponseId Int

  action        String // created, updated, submitted, withdrawn, evaluated
  changes       Json? // What changed
  previousValue Json? // Before state
  newValue      Json? // After state

  performedBy     Int? // User ID
  performedByType String? // user, system, supplier
  performedAt     DateTime @default(now())
  ipAddress       String?

  @@index([tenantId, packageResponseId])
  @@index([performedAt])
}

model TenderBid {
  id         Int      @id @default(autoincrement())
  tenantId   String   @default("demo")
  tenderId   Int
  supplierId Int
  price      Decimal  @db.Decimal(18, 2)
  notes      String?
  createdAt  DateTime @default(now())

  tender Tender @relation(fields: [tenderId], references: [id])

  @@index([tenantId, tenderId])
}

// --- Tender Portal & Scoring Models (for tenders.portal.cjs and tenders.scoring.cjs) ---

/// Evaluation criteria for tender scoring (price, technical, programme, h&s, esg, past performance, risk)
model TenderCriteria {
  id       Int     @id @default(autoincrement())
  tenantId String  @default("demo")
  tenderId Int     @map("tender_id")
  name     String
  weight   Decimal @db.Decimal(5, 2)
  type     String // 'price'|'technical'|'programme'|'h&s'|'esg'|'past'|'risk'

  scores TenderScore[]

  @@index([tenantId, tenderId])
  @@map("TenderCriteria")
}

/// Supplier submissions via token-based portal
model TenderSubmission {
  id          Int       @id @default(autoincrement())
  tenantId    String    @default("demo")
  tenderId    Int       @map("tender_id")
  supplierId  Int       @map("supplier_id")
  accessToken String    @unique @map("access_token")
  status      String    @default("draft") // 'draft'|'submitted'
  formData    Json?     @map("form_data")
  totalPrice  Decimal   @default(0) @map("total_price") @db.Decimal(18, 2)
  submittedAt DateTime? @map("submitted_at")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  supplier Supplier?              @relation("TenderSubmissionSupplier", fields: [supplierId], references: [id])
  items    TenderSubmissionItem[]
  qnas     TenderQnA[]
  scores   TenderScore[]

  @@index([tenantId, tenderId])
  @@index([tenantId, supplierId])
  @@index([tenantId, status])
  @@map("TenderSubmission")
}

/// Line-level pricing items in supplier submissions
model TenderSubmissionItem {
  id           Int      @id @default(autoincrement())
  tenantId     String   @default("demo")
  submissionId Int      @map("submission_id")
  description  String
  quantity     Decimal  @db.Decimal(18, 4)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(18, 4)
  total        Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submission TenderSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([tenantId, submissionId])
  @@map("TenderSubmissionItem")
}

/// Q&A between suppliers and buyers during tender process
model TenderQnA {
  id              Int       @id @default(autoincrement())
  tenantId        String    @default("demo")
  tenderId        Int       @map("tender_id")
  submissionId    Int?      @map("submission_id")
  question        String
  answer          String?
  answeredAt      DateTime? @map("answered_at")
  supplierVisible Boolean   @default(false) @map("supplier_visible")
  createdAt       DateTime  @default(now())

  submission TenderSubmission? @relation(fields: [submissionId], references: [id])

  @@index([tenantId, tenderId])
  @@index([tenantId, submissionId])
  @@map("TenderQnA")
}

/// Auto and manual scores for tender evaluation
model TenderScore {
  id             Int      @id @default(autoincrement())
  tenantId       String   @default("demo")
  criteriaId     Int      @map("criteria_id")
  submissionId   Int      @map("submission_id")
  autoScore      Decimal? @map("auto_score") @db.Decimal(8, 2)
  manualScore    Decimal? @map("manual_score") @db.Decimal(8, 2)
  overrideReason String?  @map("override_reason")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  criteria   TenderCriteria   @relation(fields: [criteriaId], references: [id])
  submission TenderSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([criteriaId, submissionId])
  @@index([tenantId, submissionId])
  @@map("TenderScore")
}

model TenderInvite {
  id          Int       @id @default(autoincrement())
  packageId   Int
  package     Package   @relation(name: "PackageInvites", fields: [packageId], references: [id])
  supplierId  Int
  supplier    Supplier  @relation("SupplierInvites", fields: [supplierId], references: [id])
  invitedAt   DateTime  @default(now())
  respondedAt DateTime?
  status      String    @default("Invited")

  submission Submission? @relation("TenderInviteSubmission")

  @@unique([packageId, supplierId])
  @@index([supplierId])
}

model Submission {
  id             Int      @id @default(autoincrement())
  packageId      Int
  package        Package  @relation(name: "PackageSubmissions", fields: [packageId], references: [id])
  supplierId     Int
  supplier       Supplier @relation("SupplierSubmissions", fields: [supplierId], references: [id])
  submittedAt    DateTime @default(now())
  price          Decimal?
  durationWeeks  Int?
  technicalScore Float?
  priceScore     Float?
  overallScore   Float?
  rank           Int?
  status         String   @default("Submitted")
  details        Json?

  invite TenderInvite? @relation("TenderInviteSubmission", fields: [packageId, supplierId], references: [packageId, supplierId])

  @@unique([packageId, supplierId])
  @@index([packageId])
  @@index([supplierId])
}

model Award {
  id             Int      @id @default(autoincrement())
  tenantId       String
  projectId      Int
  packageId      Int
  supplierId     Int
  awardValue     Decimal  @db.Decimal(18, 2)
  awardDate      DateTime @default(now())
  overrideUsed   Boolean  @default(false)
  overrideReason String?

  project  Project   @relation(fields: [projectId], references: [id])
  package  Package   @relation(fields: [packageId], references: [id])
  supplier Supplier  @relation(fields: [supplierId], references: [id])
  contract Contract? @relation("ContractAward")

  @@index([tenantId, packageId])
}

model Contract {
  id              Int       @id @default(autoincrement())
  projectId       Int
  packageId       Int?
  supplierId      Int
  title           String
  contractRef     String?
  value           Decimal   @db.Decimal(65, 30)
  currency        String?   @default("GBP")
  status          String    @default("draft")
  signedAt        DateTime?
  startDate       DateTime?
  endDate         DateTime?
  retentionPct    Decimal?  @db.Decimal(5, 2)
  paymentTerms    String?
  notes           String?
  internalTeam    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  originalValue   Decimal?  @db.Decimal(18, 2)
  managedByUserId Int?
  pdfUrl          String?
  tenantId        String?
  rfxId           Int?      @unique
  awardId         Int?      @unique
  draftCreatedAt  DateTime?
  lockedAt        DateTime?
  sourceMode      String?

  // relations
  project        Project                 @relation(fields: [projectId], references: [id])
  package        Package?                @relation(fields: [packageId], references: [id])
  supplier       Supplier                @relation(fields: [supplierId], references: [id])
  rfx            Rfx?                    @relation("ContractRfx", fields: [rfxId], references: [id])
  award          Award?                  @relation("ContractAward", fields: [awardId], references: [id])
  lineItems      ContractLineItem[]
  applications   ApplicationForPayment[]
  invoices       Invoice[]
  purchaseOrders PurchaseOrder[]
  documents      ContractDocument[]
  approvalSteps  ContractApprovalStep[]
  approvals      ContractApproval[]
  files          ContractFile[]

  @@index([projectId])
  @@index([supplierId])
  @@index([tenantId])
  @@index([packageId])
  @@index([tenantId, packageId])
}

/// Line items copied initially from PackageLineItem snapshot (or entered manually).
model ContractLineItem {
  id                Int      @id @default(autoincrement())
  contractId        Int
  packageLineItemId Int?
  budgetLineId      Int?
  description       String
  qty               Decimal  @db.Decimal(18, 4)
  rate              Decimal  @db.Decimal(18, 4)
  total             Decimal  @db.Decimal(18, 2)
  costCode          String?
  tenantId          String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // relations
  contract        Contract         @relation(fields: [contractId], references: [id])
  packageLineItem PackageLineItem? @relation("PackageLineContractLines", fields: [packageLineItemId], references: [id])
  budgetLine      BudgetLine?      @relation("BudgetLineContractLines", fields: [budgetLineId], references: [id])

  @@index([tenantId, contractId])
  @@index([tenantId, costCode])
  @@index([tenantId, budgetLineId])
  @@index([tenantId, packageLineItemId])
}

/// Contract document system: editable docs with versioning
model ContractDocument {
  id         Int      @id @default(autoincrement())
  tenantId   String
  contractId Int
  title      String   @default("Subcontract Agreement")
  editorType String   @default("prosemirror") // prosemirror|onlyoffice|collabora
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())

  contract Contract          @relation(fields: [contractId], references: [id])
  versions ContractVersion[]

  @@index([tenantId, contractId])
}

/// Immutable version snapshots with redline diffs
model ContractVersion {
  id            Int      @id @default(autoincrement())
  tenantId      String
  contractDocId Int
  versionNo     Int
  contentJson   Json // ProseMirror JSON or docx key
  baseVersionId Int? // for diffing/redlines
  redlinePatch  Json? // stringified diff or JSON patch
  createdBy     Int? // userId
  createdAt     DateTime @default(now())

  document ContractDocument @relation(fields: [contractDocId], references: [id])

  @@index([tenantId, contractDocId, versionNo])
}

/// Approval workflow steps
model ContractApprovalStep {
  id         Int      @id @default(autoincrement())
  tenantId   String
  contractId Int
  seq        Int
  role       String // e.g., "QS", "Commercial Manager"
  required   Boolean  @default(true)
  createdAt  DateTime @default(now())

  contract  Contract           @relation(fields: [contractId], references: [id])
  approvals ContractApproval[]

  @@index([tenantId, contractId, seq])
}

/// Individual approval decisions
model ContractApproval {
  id         Int       @id @default(autoincrement())
  tenantId   String
  contractId Int
  stepId     Int
  userId     Int
  decision   String? // "Approved"|"Rejected"|null
  comment    String?
  decidedAt  DateTime?
  createdAt  DateTime  @default(now())

  contract Contract             @relation(fields: [contractId], references: [id])
  step     ContractApprovalStep @relation(fields: [stepId], references: [id])

  @@index([tenantId, contractId, stepId])
}

model ContractFile {
  id         Int      @id @default(autoincrement())
  tenantId   String
  contractId Int
  versionId  Int?
  path       String
  mime       String   @default("application/vnd.openxmlformats-officedocument.wordprocessingml.document")
  size       Int
  createdAt  DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([tenantId, contractId])
}

model ContractTemplate {
  id        Int      @id @default(autoincrement())
  tenantId  String   @db.VarChar(64)
  key       String
  name      String
  version   String?
  bodyHtml  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId, updatedAt])
}

// --- Cost Value Reconciliation (additive) ---
model CostValueReconciliation {
  id             Int      @id @default(autoincrement())
  tenantId       String
  projectId      Int
  period         String // YYYY-MM
  budget         Decimal  @default(0) @db.Decimal(18, 2)
  committed      Decimal  @default(0) @db.Decimal(18, 2)
  actual         Decimal  @default(0) @db.Decimal(18, 2)
  earnedValue    Decimal  @default(0) @db.Decimal(18, 2)
  costVariance   Decimal  @default(0) @db.Decimal(18, 2)
  costToComplete Decimal  @default(0) @db.Decimal(18, 2)
  marginPct      Decimal  @default(0) @db.Decimal(9, 4)
  notes          String?
  justification  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  lines CVRLine[]

  @@index([tenantId, projectId])
  @@index([tenantId, period])
}

model CVRLine {
  id          Int      @id @default(autoincrement())
  tenantId    String
  cvrId       Int
  packageId   Int?
  costCode    String?
  budget      Decimal  @default(0) @db.Decimal(18, 2)
  committed   Decimal  @default(0) @db.Decimal(18, 2)
  actual      Decimal  @default(0) @db.Decimal(18, 2)
  earnedValue Decimal  @default(0) @db.Decimal(18, 2)
  variance    Decimal  @default(0) @db.Decimal(18, 2)
  adjustment  Decimal  @default(0) @db.Decimal(18, 2)
  adjusted    Decimal  @default(0) @db.Decimal(18, 2)
  variationId Int?
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cvr CostValueReconciliation @relation(fields: [cvrId], references: [id])

  @@index([tenantId, cvrId])
  @@index([tenantId, packageId])
}

// --- Project Diary (additive) ---
model DiaryEntry {
  id          Int      @id @default(autoincrement())
  tenantId    String
  projectId   Int
  date        DateTime
  description String
  issues      String?
  createdBy   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, projectId, date])
}

// AuditLog moved to line 2720 (more comprehensive version with tenantId)

model CVRSnapshot {
  id        Int      @id @default(autoincrement())
  tenantId  String
  projectId Int
  period    String // "YYYY-MM"
  status    String? // "draft" | "submitted" | "approved" (string, not enum)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines CVRSnapshotLine[]

  @@index([tenantId, projectId, period])
  @@index([tenantId, status])
}

model CVRSnapshotLine {
  id           Int     @id @default(autoincrement())
  tenantId     String
  snapshotId   Int
  projectId    Int
  budgetLineId Int?
  packageId    Int?
  contractId   Int?
  code         String?
  name         String?

  planned      Decimal @default(0) @db.Decimal(18, 2) // from BudgetLine.planned at seed
  estimate     Decimal @default(0) @db.Decimal(18, 2) // from Contract value (sum per package)
  actualToDate Decimal @default(0) @db.Decimal(18, 2) // sum of invoices up to period end

  progressPct Decimal @default(0) @db.Decimal(5, 2) // editable % complete this period (0-100)
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  snapshot CVRSnapshot @relation(fields: [snapshotId], references: [id])

  @@index([tenantId, snapshotId])
  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
  @@index([tenantId, budgetLineId])
  @@index([tenantId, contractId])
}

// --- Additive: Budget CSV import tracking (preview/commit) ---
model ImportJob {
  id         Int      @id @default(autoincrement())
  tenantId   String
  projectId  Int
  filename   String
  status     String // 'preview' | 'committed' | 'failed' (kept as string for flexibility)
  rowCount   Int      @default(0)
  errorCount Int      @default(0)
  preview    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([tenantId, projectId])
}

model RfxSection {
  id        Int      @id @default(autoincrement())
  tenantId  String
  rfxId     Int
  title     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfx       Rfx           @relation(fields: [rfxId], references: [id])
  questions RfxQuestion[]

  @@index([tenantId, rfxId])
}

model RfxQuestion {
  id           Int      @id @default(autoincrement())
  tenantId     String
  rfxId        Int
  sectionId    Int?
  prompt       String
  guidance     String?
  responseType String // "text" | "number" | "file" | "multi" | "single" (store as string)
  options      String? // JSON string for options/allowed types
  required     Boolean  @default(true)
  weight       Decimal? // optional, per-question weight if needed
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rfx     Rfx         @relation(fields: [rfxId], references: [id])
  section RfxSection? @relation(fields: [sectionId], references: [id])

  @@index([tenantId, rfxId])
  @@index([tenantId, sectionId])
}

model RfxCriterion {
  id        Int      @id @default(autoincrement())
  tenantId  String
  rfxId     Int
  name      String
  type      String // "price" | "technical" | "programme" | "h&s" | "esg" | "past" | "risk"
  weight    Decimal
  config    String? // JSON string (e.g., price normalisation method)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfx Rfx @relation(fields: [rfxId], references: [id])

  @@index([tenantId, rfxId])
}

model RfxInvite {
  id          Int       @id @default(autoincrement())
  tenantId    String
  rfxId       Int
  supplierId  Int
  status      String // "draft" | "sent" | "responded" | "withdrawn"
  token       String // for magic-link supplier portal
  sentAt      DateTime?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  rfx Rfx @relation(fields: [rfxId], references: [id])

  @@index([tenantId, rfxId])
}

model RfxQna {
  id               Int       @id @default(autoincrement())
  tenantId         String
  rfxId            Int
  parentId         Int?
  visibility       String    @default("public") // "public" | "internal"
  status           String    @default("open") // "open" | "locked" (string, not enum)
  authorRole       String // "supplier" | "internal"
  authorUserId     String? // internal user ID (if internal)
  authorSupplierId Int? // supplierId (if supplier)
  content          String
  attachments      String? // JSON array of docIds or files metadata
  createdAt        DateTime  @default(now())
  editedAt         DateTime?
  editedBy         String? // user id
  rfx              Rfx       @relation(fields: [rfxId], references: [id])
  parent           RfxQna?   @relation("QnaParent", fields: [parentId], references: [id])
  children         RfxQna[]  @relation("QnaParent")
}

model RfxQnaRead {
  id         Int      @id @default(autoincrement())
  tenantId   String
  qnaId      Int
  userId     String? // internal
  supplierId Int? // supplier
  readAt     DateTime @default(now())
}

// ==========================================
// TENDER MANAGEMENT SYSTEM - TASK 3C
// ==========================================

// Supplier Pre-qualification
model SupplierPrequalification {
  id         Int    @id @default(autoincrement())
  tenantId   String
  supplierId Int    @unique

  // Company details
  companySize    String? // small, medium, large
  annualTurnover Float?
  employeeCount  Int?

  // Accreditations
  iso9001                Boolean   @default(false)
  iso9001Expiry          DateTime?
  iso14001               Boolean   @default(false)
  iso14001Expiry         DateTime?
  iso45001               Boolean   @default(false)
  iso45001Expiry         DateTime?
  chas                   Boolean   @default(false)
  chasExpiry             DateTime?
  constructionline       Boolean   @default(false)
  constructionlineExpiry DateTime?

  // Insurance
  publicLiabilityAmount    Float?
  publicLiabilityExpiry    DateTime?
  employersLiabilityAmount Float?
  employersLiabilityExpiry DateTime?

  // Performance
  averagePerformanceScore Float? // 0-5 stars
  onTimeDeliveryRate      Float? // Percentage
  currentWorkload         Float? // Percentage
  availableCapacity       Float? // £ value

  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// Tender Invitations
model TenderInvitation {
  id         Int    @id @default(autoincrement())
  tenantId   String
  requestId  Int
  supplierId Int

  // Tracking
  invitedAt           DateTime  @default(now())
  invitedBy           Int?
  viewedAt            DateTime?
  viewCount           Int       @default(0)
  documentsDownloaded Json? // Array of {docId, timestamp}

  // Status
  status        String    @default("invited") // invited, viewed, declined, submitted
  declinedAt    DateTime?
  declineReason String?   @db.Text

  // Site visit
  siteVisitBooked Boolean   @default(false)
  siteVisitSlot   DateTime?

  // Unique access token
  accessToken String @unique @default(uuid())

  // Relations
  supplier      Supplier @relation("TenderInvitationSupplier", fields: [supplierId], references: [id])
  invitedByUser User?    @relation("TenderInvitationInvitedBy", fields: [invitedBy], references: [id])

  @@unique([tenantId, requestId, supplierId])
  @@index([tenantId, requestId])
  @@index([accessToken])
}

// Tender Documents
model TenderDocument {
  id        Int    @id @default(autoincrement())
  tenantId  String
  requestId Int

  name     String
  category String // drawings, specifications, commercial, site_info, legal
  fileUrl  String
  fileSize Int // Bytes
  fileType String // pdf, dwg, xlsx
  version  String @default("1.0")

  description String? @db.Text
  isAddendum  Boolean @default(false)
  supersedes  Int? // Previous document ID
  isMandatory Boolean @default(true)

  uploadedAt    DateTime @default(now())
  uploadedBy    Int?
  downloadCount Int      @default(0)

  downloads TenderDocumentDownload[]

  @@index([tenantId, requestId])
}

model TenderDocumentDownload {
  id           Int      @id @default(autoincrement())
  tenantId     String
  documentId   Int
  supplierId   Int
  downloadedAt DateTime @default(now())
  ipAddress    String?

  document TenderDocument @relation(fields: [documentId], references: [id])

  @@index([tenantId, documentId])
  @@index([tenantId, supplierId])
}

// Q&A System
model TenderClarification {
  id        Int    @id @default(autoincrement())
  tenantId  String
  requestId Int

  question String   @db.Text
  askedBy  Int? // Supplier ID (nullable for anonymous)
  askedAt  DateTime @default(now())

  answer     String?   @db.Text
  answeredBy Int? // User ID
  answeredAt DateTime?

  isPublic Boolean @default(true)
  status   String  @default("pending") // pending, answered, withdrawn

  questionAttachments Json?
  answerAttachments   Json?

  notifiedSuppliers Boolean   @default(false)
  notifiedAt        DateTime?

  @@index([tenantId, requestId])
  @@index([status])
}

// Timeline Events
model TenderTimelineEvent {
  id        Int    @id @default(autoincrement())
  tenantId  String
  requestId Int

  eventType   String // issue, site_visit, clarification_deadline, submission_deadline
  eventName   String
  eventDate   DateTime
  description String?  @db.Text
  location    String?

  reminderSent Boolean @default(false)
  reminderDays Json? // [3, 1] days before

  status      String    @default("scheduled") // scheduled, completed, cancelled
  completedAt DateTime?

  maxAttendees Int?

  createdAt DateTime @default(now())

  bookings TenderSiteVisitBooking[]

  @@index([tenantId, requestId])
  @@index([eventDate])
}

model TenderSiteVisitBooking {
  id              Int    @id @default(autoincrement())
  tenantId        String
  timelineEventId Int
  supplierId      Int

  bookedAt      DateTime @default(now())
  attendees     String?
  attendeeCount Int      @default(1)

  status      String    @default("confirmed") // confirmed, cancelled, no_show
  cancelledAt DateTime?
  checkedInAt DateTime?

  event TenderTimelineEvent @relation(fields: [timelineEventId], references: [id])

  @@index([tenantId, timelineEventId])
}

// Evaluation & Scoring
model TenderEvaluation {
  id          Int    @id @default(autoincrement())
  tenantId    String
  requestId   Int
  responseId  Int
  evaluatorId Int

  evaluationType String // individual, consensus

  technicalScore      Float?
  commercialScore     Float?
  programmeScore      Float?
  complianceScore     Float?
  sustainabilityScore Float?
  totalScore          Float?

  criteriaScores Json? // Detailed breakdown

  strengths           String? @db.Text
  weaknesses          String? @db.Text
  risks               String? @db.Text
  recommendation      String? // award, reserve, reject
  recommendationNotes String? @db.Text

  status      String    @default("draft") // draft, submitted
  submittedAt DateTime?

  hasConflictOfInterest Boolean @default(false)
  conflictDetails       String? @db.Text

  @@index([tenantId, requestId])
  @@index([evaluatorId])
}

model TenderEvaluationCriteria {
  id        Int    @id @default(autoincrement())
  tenantId  String
  requestId Int

  name        String
  description String? @db.Text
  category    String // price, technical, compliance
  weight      Float // Percentage (0-100)
  maxScore    Float   @default(100)

  scoringGuide    String? @db.Text
  scoringExamples Json?
  orderIndex      Int     @default(0)

  @@index([tenantId, requestId])
}

// Notifications
model TenderNotification {
  id        BigInt @id @default(autoincrement())
  tenantId  String
  requestId Int?

  recipientType String // user, supplier, role
  recipientId   Int?
  recipientRole String?

  type     String // invitation, reminder, clarification, award
  title    String
  message  String @db.Text
  priority String @default("normal") // low, normal, high, urgent

  sendEmail Boolean @default(true)
  sendSms   Boolean @default(false)
  sendInApp Boolean @default(true)

  status        String    @default("pending") // pending, sent, failed, read
  sentAt        DateTime?
  readAt        DateTime?
  failureReason String?

  actionUrl   String?
  actionLabel String?

  createdAt DateTime @default(now())

  @@index([tenantId, recipientId])
  @@index([status, createdAt])
}

model NotificationTemplate {
  id       Int    @id @default(autoincrement())
  tenantId String

  name     String
  code     String @unique
  category String

  emailSubject String?
  emailBody    String? @db.Text
  smsBody      String?
  inAppTitle   String?
  inAppBody    String? @db.Text

  availableVariables Json?
  isActive           Boolean @default(true)
  defaultPriority    String  @default("normal")

  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([code])
}

// AI & Analytics
model TenderAIAnalysis {
  id         Int    @id @default(autoincrement())
  tenantId   String
  requestId  Int
  responseId Int?

  analysisType String // risk_assessment, score_suggestion, anomaly_detection
  findings     Json
  riskLevel    String? // low, medium, high
  confidence   Float?

  recommendations Json?
  modelVersion    String?
  analysisDate    DateTime @default(now())

  @@index([tenantId, requestId])
  @@index([analysisType])
}

model TenderAnalytics {
  id        Int    @id @default(autoincrement())
  tenantId  String
  requestId Int

  invitationsSent    Int @default(0)
  viewCount          Int @default(0)
  uniqueViewers      Int @default(0)
  documentDownloads  Int @default(0)
  clarificationCount Int @default(0)
  submissionCount    Int @default(0)

  daysToAward         Int?
  daysInEvaluation    Int?
  averageResponseTime Int? // Days from invitation to submission

  winningPrice Float?
  secondPrice  Float?
  priceSavings Float?
  qualityScore Float?

  updatedAt DateTime @updatedAt

  @@unique([tenantId, requestId])
  @@index([tenantId])
}

model TenderBenchmark {
  id       Int    @id @default(autoincrement())
  tenantId String

  tradeCategory String
  projectType   String?
  region        String?
  valueRange    String?

  averagePrice       Float?
  medianPrice        Float?
  priceRange         Json?
  averageProgramme   Int?
  averageDaysToAward Int?

  sampleSize Int
  dateFrom   DateTime
  dateTo     DateTime
  updatedAt  DateTime @updatedAt

  @@index([tenantId, tradeCategory])
}

// Audit Trail
model TenderAuditLog {
  id        BigInt @id @default(autoincrement())
  tenantId  String
  requestId Int

  action     String
  entityType String
  entityId   Int?

  actorType String // user, supplier, system
  actorId   Int?
  actorName String?

  changes Json?
  reason  String? @db.Text

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([tenantId, requestId])
  @@index([createdAt])
  @@index([actorType, actorId])
}

// Response model (if not exists - for tender submissions)
model Response {
  id         Int    @id @default(autoincrement())
  tenantId   String
  requestId  Int
  supplierId Int

  // Submission data
  answers      Json?
  boqData      Json?
  priceTotal   Float?
  leadTimeDays Int?

  // Scoring
  technicalScore  Float?
  commercialScore Float?
  weightedScore   Float?
  rank            Int?

  // Status
  status      String    @default("draft") // draft, submitted, withdrawn
  submittedAt DateTime?
  lastSavedAt DateTime?
  saveCount   Int       @default(0)

  // Award
  isAwarded Boolean   @default(false)
  awardedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, requestId, supplierId])
  @@index([tenantId, requestId])
  @@index([tenantId, supplierId])
}

// Approval workflow (generic, can be used for tender awards)
model Approval {
  id       Int    @id @default(autoincrement())
  tenantId String

  entityType String // tender_award, contract_variation, etc.
  entityId   Int

  approverId    String
  requestedById String

  status   String  @default("pending") // pending, approved, rejected
  notes    String? @db.Text
  comments String? @db.Text
  metadata Json?

  respondedAt   DateTime?
  respondedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, entityType, entityId])
  @@index([approverId, status])
}

// Existing AuditLog - for backwards compatibility
model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  userId    Int?
  entity    String
  entityId  String
  action    String
  changes   Json?
  ipAddress String?

  @@index([entity, entityId])
}

// ============================================================================
// JOB MANAGEMENT & SCHEDULING MODELS
// ============================================================================

enum JobStatus {
  DRAFT // Initial creation
  PENDING // Awaiting scheduling
  SCHEDULED // Assigned to workers, date set
  ASSIGNED // Workers confirmed
  IN_PROGRESS // Work started
  ON_HOLD // Temporarily paused
  COMPLETED // Work finished
  CANCELLED // Job cancelled
  INVOICED // Billed to client
}

enum JobPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum WorkerAvailabilityStatus {
  AVAILABLE
  ASSIGNED
  UNAVAILABLE
  ON_LEAVE
  OFF_DUTY
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
  RESERVED
}

enum TimeEntryStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}

enum ScheduleStatus {
  PENDING // Created, awaiting confirmation
  CONFIRMED // Worker confirmed
  IN_PROGRESS // Job started
  COMPLETED // Job finished
  CANCELLED // Cancelled
  NO_SHOW // Worker didn't show up
}

enum ConflictType {
  WORKER_OVERLAP
  WORKER_UNAVAILABLE
  EQUIPMENT_OVERLAP
  EQUIPMENT_UNAVAILABLE
  SKILL_MISMATCH
  CAPACITY_EXCEEDED
}

enum ConflictSeverity {
  CRITICAL // Blocks schedule creation
  HIGH // Warning, can proceed with override
  MEDIUM // Informational
  LOW // Suggestion
}

// ============================================================================
// MAIN JOB MODEL
// ============================================================================

model Job {
  id       String @id @default(uuid())
  tenantId String

  // Auto-generated job number (e.g., JOB-2025-0001)
  jobNumber String @unique

  // Link to existing ERP entities
  projectId  Int? // Optional: link to Project
  packageId  Int? // Optional: created from awarded Package
  contractId Int? // Optional: link to Contract
  clientId   Int? // Link to existing Client/Company

  // Job Details
  title       String
  description String?     @db.Text
  jobType     String // e.g., "Installation", "Repair", "Inspection"
  status      JobStatus   @default(DRAFT)
  priority    JobPriority @default(NORMAL)

  // Location
  siteAddress        String   @db.Text
  siteCity           String?
  sitePostcode       String?
  siteLatitude       Decimal? @db.Decimal(10, 8)
  siteLongitude      Decimal? @db.Decimal(11, 8)
  accessInstructions String?  @db.Text

  // Scope & Requirements
  scopeOfWork         String?  @db.Text
  requiredSkills      String[] // Array of skill names
  requiredCerts       String[] // Array of certification names
  requiredWorkerCount Int      @default(1)

  // Scheduling
  estimatedDuration  Float? // Hours
  scheduledStartDate DateTime?
  scheduledEndDate   DateTime?
  actualStartDate    DateTime?
  actualEndDate      DateTime?

  // Financial (links to CVR)
  estimatedCost  Decimal?  @db.Decimal(12, 2)
  actualCost     Decimal?  @db.Decimal(12, 2)
  billableAmount Decimal?  @db.Decimal(12, 2)
  invoiceNumber  String?
  invoicedAt     DateTime?

  // Safety & Compliance
  riskAssessment  String? @db.Text
  methodStatement String? @db.Text
  permitRequired  Boolean @default(false)
  permitNumber    String?

  // Audit Trail
  createdAt          DateTime  @default(now())
  createdBy          String // User ID
  updatedAt          DateTime  @updatedAt
  updatedBy          String? // User ID
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?   @db.Text

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  // Relations
  schedules     JobSchedule[]
  materials     JobMaterial[]
  timeEntries   TimeEntry[]
  notes         JobNote[]
  statusHistory JobStatusHistory[]
  documents     JobDocument[]
  checklists    JobChecklist[]

  // Indexes
  @@index([tenantId, status])
  @@index([tenantId, projectId])
  @@index([tenantId, packageId])
  @@index([tenantId, contractId])
  @@index([tenantId, clientId])
  @@index([tenantId, scheduledStartDate])
  @@index([jobNumber])
  @@map("jobs")
}

// ============================================================================
// WORKERS MODEL
// ============================================================================

model Worker {
  id       String @id @default(uuid())
  tenantId String

  // Auto-generated worker number
  workerNumber String @unique

  // Personal Info
  firstName String
  lastName  String
  email     String?
  phone     String?

  // Work Details
  role           String // e.g., "Electrician", "Plumber", "Site Manager"
  department     String?
  skills         String[] // Array of skill names
  certifications Json? // {certName: {number, expiryDate, issuer}}

  // Availability
  availabilityStatus WorkerAvailabilityStatus @default(AVAILABLE)
  workSchedule       Json? // Weekly schedule: {monday: {start, end}, ...}

  // Location (for GPS tracking)
  homePostcode       String?
  currentLatitude    Decimal?  @db.Decimal(10, 8)
  currentLongitude   Decimal?  @db.Decimal(11, 8)
  lastLocationUpdate DateTime?

  // Compensation (for cost tracking)
  hourlyRate   Decimal? @db.Decimal(8, 2)
  overtimeRate Decimal? @db.Decimal(8, 2)

  // Employment
  hireDate DateTime?
  isActive Boolean   @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  schedules    JobSchedule[]
  timeEntries  TimeEntry[]
  availability WorkerAvailability[]

  // Indexes
  @@index([tenantId, availabilityStatus])
  @@index([tenantId, role])
  @@index([tenantId, isActive])
  @@index([email])
  @@map("workers")
}

// ============================================================================
// EQUIPMENT/ASSETS MODEL
// ============================================================================

model Equipment {
  id       String @id @default(uuid())
  tenantId String

  // Auto-generated equipment number
  equipmentNumber String @unique

  // Equipment Details
  name         String
  type         String // e.g., "Van", "Drill", "Scaffold"
  category     String? // e.g., "Vehicle", "Power Tool", "Access Equipment"
  manufacturer String?
  model        String?
  serialNumber String?

  // Status & Location
  status           EquipmentStatus @default(AVAILABLE)
  currentLocation  String?
  currentLatitude  Decimal?        @db.Decimal(10, 8)
  currentLongitude Decimal?        @db.Decimal(11, 8)

  // Maintenance
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  maintenanceInterval Int? // Days

  // Financial
  purchaseDate DateTime?
  purchaseCost Decimal?  @db.Decimal(12, 2)
  hourlyRate   Decimal?  @db.Decimal(8, 2)
  dailyRate    Decimal?  @db.Decimal(8, 2)

  // Specifications (flexible JSON field)
  specifications Json?

  // Status
  isActive Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  schedules JobSchedule[]

  // Indexes
  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([equipmentNumber])
  @@map("equipment")
}

// ============================================================================
// JOB SCHEDULE MODEL (Assignment of Workers & Equipment to Jobs)
// ============================================================================

model JobSchedule {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Scheduling
  startTime      DateTime
  endTime        DateTime
  estimatedHours Decimal  @default(0) @db.Decimal(10, 2)
  allDay         Boolean  @default(false)

  // Assignments
  workerId    String?
  equipmentId String?
  isCrewLead  Boolean  @default(false)
  assignedBy  String
  assignedAt  DateTime @default(now())

  // Travel & Setup
  travelTimeMinutes    Int @default(0)
  setupTimeMinutes     Int @default(0)
  breakdownTimeMinutes Int @default(0)

  // Status
  status               ScheduleStatus @default(PENDING)
  confirmationRequired Boolean        @default(true)
  confirmedAt          DateTime?
  confirmedBy          String? // Worker ID who confirmed

  // Notes
  notes               String? @db.Text
  specialInstructions String? @db.Text

  // Conflicts
  hasConflicts    Boolean @default(false)
  conflictDetails Json?

  // Audit
  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String?

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  // Relations
  job         Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  worker      Worker?            @relation(fields: [workerId], references: [id])
  equipment   Equipment?         @relation(fields: [equipmentId], references: [id])
  timeEntries TimeEntry[]
  conflicts   ScheduleConflict[]

  // Validation
  @@index([tenantId, jobId])
  @@index([tenantId, workerId, startTime])
  @@index([tenantId, equipmentId, startTime])
  @@index([tenantId, startTime])
  @@index([status])
  @@map("job_schedules")
}

// ============================================================================
// SCHEDULE CONFLICT TRACKING MODEL
// ============================================================================

model ScheduleConflict {
  id         String @id @default(uuid())
  tenantId   String
  scheduleId String

  // Conflict Details
  conflictType ConflictType
  severity     ConflictSeverity
  resourceId   String // workerId or equipmentId
  resourceType String // 'worker' or 'equipment'

  conflictingScheduleId     String?
  conflictingAvailabilityId String? // WorkerAvailability ID for time off conflicts

  message String
  details Json?

  // Resolution
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?   @db.Text

  // Audit
  createdAt DateTime @default(now())

  // Relations
  schedule JobSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, scheduleId])
  @@index([resourceId, resourceType])
  @@index([conflictType, severity])
  @@map("schedule_conflicts")
}

// ============================================================================
// JOB MATERIALS MODEL (Linked to existing Inventory)
// ============================================================================

model JobMaterial {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Material Details
  itemName        String
  itemSKU         String?
  itemDescription String? @db.Text

  // Quantities
  quantityRequired  Decimal @db.Decimal(10, 2)
  quantityAllocated Decimal @default(0) @db.Decimal(10, 2)
  quantityUsed      Decimal @default(0) @db.Decimal(10, 2)
  unitOfMeasure     String  @default("each")

  // Inventory Link (to your existing inventory system)
  inventoryItemId   String? // Link to existing inventory item
  supplierId        String? // Link to existing supplier
  inventoryLocation String?

  // Status
  status String @default("pending") // pending, ordered, allocated, delivered, used, returned

  // Financial
  unitCost  Decimal? @db.Decimal(10, 2)
  totalCost Decimal? @db.Decimal(12, 2)

  // Dates
  neededByDate  DateTime?
  orderedDate   DateTime?
  deliveredDate DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  isDeleted Boolean @default(false)

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, jobId])
  @@index([tenantId, status])
  @@map("job_materials")
}

// ============================================================================
// TIME TRACKING MODEL
// ============================================================================

model TimeEntry {
  id         String  @id @default(uuid())
  tenantId   String
  jobId      String
  workerId   String
  scheduleId String?

  // Time Details
  clockIn       DateTime
  clockOut      DateTime?
  breakStart    DateTime?
  breakEnd      DateTime?
  breakDuration Int       @default(0) // Minutes

  // Location Verification (GPS check-in)
  clockInLatitude   Decimal? @db.Decimal(10, 8)
  clockInLongitude  Decimal? @db.Decimal(11, 8)
  clockOutLatitude  Decimal? @db.Decimal(10, 8)
  clockOutLongitude Decimal? @db.Decimal(11, 8)
  locationVerified  Boolean  @default(false)

  // Status & Approval
  status          TimeEntryStatus @default(DRAFT)
  approvedBy      String? // Manager user ID
  approvedAt      DateTime?
  rejectionReason String?         @db.Text

  // Work Details
  notes         String? @db.Text
  workPerformed String? @db.Text

  // Financial
  hourlyRate   Decimal? @db.Decimal(8, 2)
  overtimeRate Decimal? @db.Decimal(8, 2)
  totalHours   Decimal? @db.Decimal(5, 2)
  totalCost    Decimal? @db.Decimal(10, 2)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  isDeleted Boolean @default(false)

  // Relations
  job      Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  worker   Worker       @relation(fields: [workerId], references: [id])
  schedule JobSchedule? @relation(fields: [scheduleId], references: [id])

  // Indexes
  @@index([tenantId, jobId])
  @@index([tenantId, workerId])
  @@index([tenantId, status])
  @@index([tenantId, clockIn])
  @@map("time_entries")
}

// ============================================================================
// JOB NOTES/COMMUNICATIONS MODEL
// ============================================================================

model JobNote {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Content
  authorId String // User ID
  message  String @db.Text
  noteType String @default("general") // general, issue, update, instruction, client_communication

  // Attachments (links to file storage)
  attachments Json? // [{filename, url, type, size}, ...]

  // Visibility
  isInternal Boolean @default(true)
  isPinned   Boolean @default(false)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, jobId])
  @@index([tenantId, createdAt])
  @@map("job_notes")
}

// ============================================================================
// JOB STATUS HISTORY MODEL (Audit Trail)
// ============================================================================

model JobStatusHistory {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Status Change
  oldStatus    JobStatus
  newStatus    JobStatus
  changeReason String?   @db.Text

  // User Info
  changedBy String // User ID
  changedAt DateTime @default(now())

  // Additional Context
  additionalData Json?

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, jobId])
  @@index([changedAt])
  @@map("job_status_history")
}

// ============================================================================
// SUPPORTING MODELS
// ============================================================================

model WorkerAvailability {
  id       String @id @default(uuid())
  tenantId String
  workerId String

  // Time Period
  startDate DateTime
  endDate   DateTime
  allDay    Boolean  @default(true)

  // Type
  availabilityType String // time_off, vacation, sick_leave, personal, training, unavailable
  reason           String? @db.Text

  // Status (for approval workflow)
  status     String    @default("pending") // pending, approved, denied
  approvedBy String? // Manager user ID
  approvedAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, workerId])
  @@index([tenantId, startDate, endDate])
  @@map("worker_availability")
}

model JobTemplate {
  id       String @id @default(uuid())
  tenantId String

  // Template Info
  templateName String
  jobType      String
  description  String? @db.Text

  // Default Values
  estimatedDuration   Float? // Hours
  requiredSkills      String[]
  requiredCerts       String[]
  requiredWorkerCount Int         @default(1)
  defaultPriority     JobPriority @default(NORMAL)

  // Template Materials
  templateMaterials Json? // [{item, quantity, unit}, ...]

  // Template Checklist
  templateTasks Json? // [{task, description, order}, ...]

  // Status
  isActive Boolean @default(true)

  // Usage Tracking
  usedCount  Int       @default(0)
  lastUsedAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([tenantId, jobType])
  @@index([tenantId, isActive])
  @@map("job_templates")
}

model JobDocument {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Document Details
  filename String
  fileUrl  String // S3/Blob storage URL
  fileType String // pdf, jpg, png, dwg, etc.
  fileSize Int // Bytes

  // Metadata
  documentType String // drawing, photo, permit, certificate, report
  description  String?  @db.Text
  uploadedBy   String // User ID
  uploadedAt   DateTime @default(now())

  // Version Control
  version          Int     @default(1)
  parentDocumentId String? // For versioning

  // Audit
  createdAt DateTime @default(now())

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, jobId])
  @@index([tenantId, documentType])
  @@map("job_documents")
}

model JobChecklist {
  id       String @id @default(uuid())
  tenantId String
  jobId    String

  // Checklist Item
  taskName     String
  description  String? @db.Text
  displayOrder Int     @default(0)

  // Status
  isCompleted Boolean   @default(false)
  completedBy String? // Worker ID
  completedAt DateTime?

  // Requirements
  isRequired    Boolean @default(true)
  requiresPhoto Boolean @default(false)
  photoUrl      String?

  // Notes
  notes String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, jobId])
  @@map("job_checklists")
}
